
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concur SAP è²»ç”¨ç”³è«‹ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 50%, #bbe1fa 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Concur é¢¨æ ¼çš„ç™»å…¥ä»‹é¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        }

        .login-form {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 450px;
            position: relative;
            overflow: hidden;
        }

        .login-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #0f4c75, #3282b8, #bbe1fa);
        }

        .login-title {
            text-align: center;
            margin-bottom: 40px;
            color: #0f4c75;
            font-size: 32px;
            font-weight: 700;
        }

        .login-subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #666;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3282b8;
            background: white;
            box-shadow: 0 0 0 3px rgba(50, 130, 184, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(15, 76, 117, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: #212529;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            color: white;
        }

        /* ä¸»ä»‹é¢ - Concur é¢¨æ ¼ */
        .main-interface {
            display: none;
        }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #0f4c75;
        }

        .header h1 {
            color: #0f4c75;
            font-size: 28px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info .user-name {
            color: #0f4c75;
            font-weight: 600;
            font-size: 16px;
        }

        /* å°èˆªæ¨™ç±¤ - Concur é¢¨æ ¼ */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            position: relative;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(15, 76, 117, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .tab-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* è¡¨å–®ä½ˆå±€ */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-col-full {
            grid-column: 1 / -1;
        }

        /* è¡¨æ ¼æ¨£å¼ - Concur é¢¨æ ¼ */
        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }

        th, td {
            padding: 18px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge {
            padding: 6px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-draft { 
            background: linear-gradient(135deg, #ffc107, #fd7e14); 
            color: #212529; 
        }
        .status-pending { 
            background: linear-gradient(135deg, #17a2b8, #20c997); 
            color: white; 
        }
        .status-testing { 
            background: linear-gradient(135deg, #6610f2, #e83e8c); 
            color: white; 
        }
        .status-approved { 
            background: linear-gradient(135deg, #28a745, #20c997); 
            color: white; 
        }
        .status-rejected { 
            background: linear-gradient(135deg, #dc3545, #fd7e14); 
            color: white; 
        }

        /* æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: #0f4c75;
            font-size: 24px;
            font-weight: 700;
        }

        .close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s;
        }

        .close:hover {
            color: #0f4c75;
        }

        /* æª”æ¡ˆä¸Šå‚³å€åŸŸ */
        .file-drop-area {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-area:hover {
            border-color: #3282b8;
            background: #e3f2fd;
            transform: translateY(-2px);
        }

        .file-drop-area.dragover {
            border-color: #0f4c75;
            background: linear-gradient(135deg, rgba(15, 76, 117, 0.1), rgba(50, 130, 184, 0.1));
        }

        .file-icon {
            font-size: 48px;
            color: #3282b8;
            margin-bottom: 15px;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #3282b8;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-name {
            font-weight: 600;
            color: #0f4c75;
        }

        .file-size {
            color: #666;
            font-size: 14px;
        }

        /* é ç®—æ§ç®¡è­¦å‘Š */
        .budget-alert {
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .budget-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left-color: #ffc107;
            color: #856404;
        }

        .budget-danger {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-left-color: #dc3545;
            color: #721c24;
        }

        .budget-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-left-color: #28a745;
            color: #155724;
        }

        /* å·¥ä½œæµç¨‹ */
        .workflow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
        }

        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex: 1;
            position: relative;
        }

        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 3px;
            background: #dee2e6;
            z-index: 1;
        }

        .workflow-step.active:not(:last-child)::after {
            background: linear-gradient(90deg, #28a745, #20c997);
        }

        .workflow-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            z-index: 2;
            position: relative;
        }

        .workflow-step.active .workflow-icon {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .workflow-step.completed .workflow-icon {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
        }

        .workflow-label {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            color: #666;
        }

        /* å„€è¡¨æ¿å¡ç‰‡ */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .dashboard-card.primary { border-left-color: #0f4c75; }
        .dashboard-card.success { border-left-color: #28a745; }
        .dashboard-card.warning { border-left-color: #ffc107; }
        .dashboard-card.danger { border-left-color: #dc3545; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #666;
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            color: #0f4c75;
        }

        /* é€²åº¦æ¢ */
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .workflow {
                flex-direction: column;
                gap: 20px;
            }
            
            .workflow-step:not(:last-child)::after {
                display: none;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-pane.active {
            animation: slideIn 0.3s ease-out;
        }

        /* æœç´¢å’Œç¯©é¸ */
        .search-filters {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .search-input {
            position: relative;
        }

        .search-input input {
            padding-left: 45px;
        }

        .search-input::before {
            content: 'ğŸ”';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥ä»‹é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-form">
            <h2 class="login-title">Concur SAP</h2>
            <p class="login-subtitle">è²»ç”¨ç”³è«‹ç®¡ç†ç³»çµ±</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">ä½¿ç”¨è€…å¸³è™Ÿ</label>
                    <input type="text" id="username" name="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç¢¼</label>
                    <input type="password" id="password" name="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required autocomplete="current-password">
                </div>
                
                <!-- å¿«é€Ÿç™»å…¥æŒ‰éˆ• -->
                <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-info" onclick="quickLogin('admin', 'admin123')" style="flex: 1; min-width: 120px; padding: 8px;">ç®¡ç†å“¡</button>
                    <button type="button" class="btn btn-warning" onclick="quickLogin('manager', 'manager123')" style="flex: 1; min-width: 120px; padding: 8px;">ç¶“ç†</button>
                    <button type="button" class="btn btn-success" onclick="quickLogin('user01', 'user123')" style="flex: 1; min-width: 120px; padding: 8px;">å“¡å·¥</button>
                </div>
                
                <!-- æ¸¬è©¦å¸³è™Ÿèªªæ˜ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0; font-size: 13px;">
                    <h4 style="color: #0f4c75; margin-bottom: 10px;">ğŸ“‹ æ‰€æœ‰æ¸¬è©¦å¸³è™Ÿ</h4>
                    <div style="display: grid; gap: 6px; font-family: monospace;">
                        <div><strong>admin</strong> / admin123 - ç³»çµ±ç®¡ç†å“¡</div>
                        <div><strong>manager</strong> / manager123 - éƒ¨é–€ç¶“ç†</div>
                        <div><strong>user01</strong> / user123 - ä¸€èˆ¬å“¡å·¥</div>
                        <div><strong>finance</strong> / finance123 - è²¡å‹™äººå“¡</div>
                        <div><strong>test</strong> / test123 - æ¸¬è©¦äººå“¡</div>
                        <div><strong>ceo</strong> / ceo123 - ç¸½ç¶“ç†</div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">ç™»å…¥ç³»çµ±</button>
            </form>
        </div>
    </div>

    <!-- ä¸»è¦ä»‹é¢ -->
    <div id="mainInterface" class="main-interface">
        <div class="container">
            <div class="header">
                <h1>Concur SAP è²»ç”¨ç”³è«‹ç³»çµ±</h1>
                <div class="user-info">
                    <span class="user-name" id="currentUser">ä½¿ç”¨è€…</span>
                    <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>

                            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">ğŸ  å„€è¡¨æ¿</button>
                <button class="nav-tab" onclick="showTab('expense')">ğŸ’° è²»ç”¨ç”³è«‹</button>
                <button class="nav-tab" onclick="showTab('pending')">ğŸ“‹ å¾…å¯©æ ¸ç®¡ç†</button>
                <button class="nav-tab" onclick="showTab('users')">ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</button>
                <button class="nav-tab" onclick="showTab('account')">ğŸ“Š æœƒè¨ˆç§‘ç›®</button>
                <button class="nav-tab" onclick="showTab('department')">ğŸ¢ éƒ¨é–€ç®¡ç†</button>
                <button class="nav-tab" onclick="showTab('budget')">ğŸ“ˆ é ç®—æ§ç®¡</button>
                <button class="nav-tab" onclick="showTab('testing')">ğŸ§ª æ¸¬è©¦æµç¨‹</button>
                <button class="nav-tab" onclick="showTab('approval')">âœ… æ ¸å‡†æµç¨‹</button>
                <button class="nav-tab" onclick="showTab('report')">ğŸ“‹ å ±è¡¨ç®¡ç†</button>
            </div>

            <!-- å„€è¡¨æ¿ -->
            <div id="dashboard" class="tab-content">
                <div class="tab-pane active">
                    <h3 style="margin-bottom: 30px; color: #0f4c75; font-size: 24px;">ç³»çµ±ç¸½è¦½</h3>
                    
                    <div class="dashboard-cards">
                        <div class="dashboard-card primary">
                            <div class="card-header">
                                <span class="card-title">ç¸½ç”³è«‹æ•¸</span>
                                <span style="font-size: 24px;">ğŸ“„</span>
                            </div>
                            <div class="card-value" id="totalExpenses">0</div>
                        </div>
                        
                        <div class="dashboard-card warning">
                            <div class="card-header">
                                <span class="card-title">å¾…å¯©æ ¸</span>
                                <span style="font-size: 24px;">â³</span>
                            </div>
                            <div class="card-value" id="pendingExpenses">0</div>
                        </div>
                        
                        <div class="dashboard-card success">
                            <div class="card-header">
                                <span class="card-title">å·²æ ¸å‡†</span>
                                <span style="font-size: 24px;">âœ…</span>
                            </div>
                            <div class="card-value" id="approvedExpenses">0</div>
                        </div>
                        
                        <div class="dashboard-card danger">
                            <div class="card-header">
                                <span class="card-title">æœ¬æœˆæ”¯å‡º</span>
                                <span style="font-size: 24px;">ğŸ’¸</span>
                            </div>
                            <div class="card-value" id="monthlySpending">$0</div>
                        </div>
                    </div>

                    <div class="budget-alert budget-success">
                        <span style="font-size: 24px;">â„¹ï¸</span>
                        <div>
                            <strong>ç³»çµ±ç‹€æ…‹ï¼š</strong>æ­£å¸¸é‹è¡Œä¸­<br>
                            <small>æœ€å¾Œæ›´æ–°ï¼š<span id="lastUpdate"></span></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è²»ç”¨ç”³è«‹é é¢ -->
            <div id="expense" class="tab-content">
                <div class="tab-pane">
                    <h3 style="margin-bottom: 30px; color: #0f4c75;">æ–°å¢è²»ç”¨ç”³è«‹</h3>
                    
                    <!-- å·¥ä½œæµç¨‹æŒ‡ç¤ºå™¨ -->
                    <div class="workflow">
                        <div class="workflow-step active">
                            <div class="workflow-icon">1</div>
                            <span class="workflow-label">å¡«å¯«è³‡æ–™</span>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-icon">2</div>
                            <span class="workflow-label">é ç®—æª¢æŸ¥</span>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-icon">3</div>
                            <span class="workflow-label">é–“æ¥ä¸»ç®¡</span>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-icon">4</div>
                            <span class="workflow-label">ç›´æ¥ä¸»ç®¡</span>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-icon">5</div>
                            <span class="workflow-label">å®Œæˆ</span>
                        </div>
                    </div>

                    <form id="expenseForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="applicant">ç”³è«‹äºº *</label>
                                <input type="text" id="applicant" name="applicant" placeholder="è«‹è¼¸å…¥ç”³è«‹äººå§“å" required>
                            </div>
                            <div class="form-group">
                                <label for="applicantDept">ç”³è«‹éƒ¨é–€ *</label>
                                <select id="applicantDept" name="applicantDept" required>
                                    <option value="">è«‹é¸æ“‡ç”³è«‹éƒ¨é–€</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="onBehalfOf">ä»£ç”³è«‹äºº</label>
                                <input type="text" id="onBehalfOf" name="onBehalfOf" placeholder="å¦‚æœ‰ä»£ç”³è«‹äººè«‹å¡«å¯«">
                            </div>
                            <div class="form-group">
                                <label for="onBehalfOfDept">ä»£ç”³è«‹éƒ¨é–€</label>
                                <select id="onBehalfOfDept" name="onBehalfOfDept">
                                    <option value="">è«‹é¸æ“‡ä»£ç”³è«‹éƒ¨é–€</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="accountCode">æœƒè¨ˆç§‘ç›® *</label>
                                <select id="accountCode" name="accountCode" required onchange="checkBudgetOnChange()">
                                    <option value="">è«‹é¸æ“‡æœƒè¨ˆç§‘ç›®</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="salesAmount">éŠ·å”®é¡ (TWD) *</label>
                                <input type="number" id="salesAmount" name="salesAmount" placeholder="0.00" required min="0" step="0.01" onchange="calculateTotal()">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="taxType">ç¨…ç‡é¡å‹</label>
                                <select id="taxType" name="taxType" onchange="updateTaxRate()">
                                    <option value="5">5% ç‡Ÿæ¥­ç¨… (ä¸€èˆ¬ç¨…ç‡)</option>
                                    <option value="0">0% å…ç¨…</option>
                                    <option value="custom">è‡ªè¨‚ç¨…ç‡</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="taxRate">ç¨…ç‡ (%)</label>
                                <input type="number" id="taxRate" name="taxRate" value="5" min="0" max="100" step="0.01" onchange="calculateTotal()" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="inputTax">é€²é …ç¨…é¡ (TWD)</label>
                                <input type="number" id="inputTax" name="inputTax" placeholder="è‡ªå‹•è¨ˆç®—" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label for="amount">ç¸½è¨ˆé‡‘é¡ (TWD) *</label>
                                <input type="number" id="amount" name="amount" placeholder="0.00" required min="0" step="0.01" readonly style="background: #f8f9fa; font-weight: bold; color: #0f4c75;">
                            </div>
                        </div>

                        <!-- ç¨…å‹™è¨ˆç®—æ˜ç´° -->
                        <div id="taxCalculationDetail" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #0f4c75;">
                            <h5 style="color: #0f4c75; margin-bottom: 10px;">ğŸ’° ç¨…å‹™è¨ˆç®—æ˜ç´°</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px;">
                                <div>
                                    <strong>éŠ·å”®é¡ï¼š</strong>
                                    <span id="displaySalesAmount">$0</span>
                                </div>
                                <div>
                                    <strong>é€²é …ç¨…é¡ï¼š</strong>
                                    <span id="displayInputTax">$0</span>
                                </div>
                                <div>
                                    <strong>é©ç”¨ç¨…ç‡ï¼š</strong>
                                    <span id="displayTaxRate">5%</span>
                                </div>
                                <div style="color: #0f4c75; font-weight: bold;">
                                    <strong>ç¸½è¨ˆé‡‘é¡ï¼š</strong>
                                    <span id="displayTotalAmount">$0</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="invoiceNumber">çµ±ä¸€ç™¼ç¥¨è™Ÿç¢¼</label>
                                <input type="text" id="invoiceNumber" name="invoiceNumber" placeholder="ä¾‹: AB12345678" pattern="[A-Z]{2}[0-9]{8}">
                            </div>
                            <div class="form-group">
                                <label for="taxId">çµ±ä¸€ç·¨è™Ÿ</label>
                                <input type="text" id="taxId" name="taxId" placeholder="ä¾‹: 12345678" pattern="[0-9]{8}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group form-col-full">
                                <label for="description">ç”³è«‹èªªæ˜ *</label>
                                <textarea id="description" name="description" rows="4" placeholder="è«‹è©³ç´°èªªæ˜è²»ç”¨ç”¨é€”å’ŒåŸå› " required></textarea>
                            </div>
                        </div>

                        <!-- é™„ä»¶ä¸Šå‚³ -->
                        <div class="form-group">
                            <label>é™„ä»¶ä¸Šå‚³</label>
                            <div class="file-drop-area" onclick="document.getElementById('fileInput').click()">
                                <div class="file-icon">ğŸ“</div>
                                <p><strong>é»æ“Šä¸Šå‚³</strong> æˆ–æ‹–æ‹½æª”æ¡ˆåˆ°æ­¤è™•</p>
                                <p style="font-size: 14px; color: #666; margin-top: 10px;">æ”¯æ´ PDF, DOC, DOCX, XLS, XLSX, JPG, PNG æ ¼å¼ï¼Œå–®æª”æœ€å¤§ 10MB</p>
                                <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" style="display: none;" onchange="handleFiles(this.files)">
                            </div>
                            <div id="fileList" class="file-list"></div>
                        </div>

                        <div id="budgetAlert"></div>

                        <div style="margin-top: 30px; display: flex; gap: 15px;">
                            <button type="submit" class="btn btn-primary">æäº¤ç”³è«‹</button>
                            <button type="button" class="btn btn-warning" onclick="saveDraft()">å„²å­˜è‰ç¨¿</button>
                            <button type="button" class="btn btn-info" onclick="testWorkflow()">æ¸¬è©¦æµç¨‹</button>
                            <button type="reset" class="btn btn-secondary">é‡ç½®è¡¨å–®</button>
                        </div>
                    </form>

                    <h3 style="margin: 50px 0 30px 0; color: #0f4c75;">æˆ‘çš„ç”³è«‹è¨˜éŒ„</h3>
                    
                    <!-- æœç´¢å’Œç¯©é¸ -->
                    <div class="search-filters">
                        <div class="search-input">
                            <input type="text" placeholder="æœç´¢ç”³è«‹è¨˜éŒ„..." onkeyup="filterExpenses()">
                        </div>
                        <div class="form-group">
                            <select id="statusFilter" onchange="filterExpenses()">
                                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="draft">è‰ç¨¿</option>
                                <option value="testing">æ¸¬è©¦ä¸­</option>
                                <option value="pending">å¾…å¯©æ ¸</option>
                                <option value="approved">å·²æ ¸å‡†</option>
                                <option value="rejected">å·²æ‹’çµ•</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="month" id="dateFilter" onchange="filterExpenses()">
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="expenseTable">
                            <thead>
                                <tr>
                                    <th>ç”³è«‹æ—¥æœŸ</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>æœƒè¨ˆç§‘ç›®</th>
                                    <th>éŠ·å”®é¡</th>
                                    <th>é€²é …ç¨…é¡</th>
                                    <th>ç¸½è¨ˆé‡‘é¡</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>é€²åº¦</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å¾…å¯©æ ¸ç®¡ç† -->
            <div id="pending" class="tab-content">
                <div class="tab-pane">
                    <h3 style="margin-bottom: 30px; color: #0f4c75;">å¾…å¯©æ ¸è²»ç”¨ç”³è«‹ç®¡ç†</h3>
                    
                    <!-- å¯©æ ¸ç‹€æ…‹çµ±è¨ˆ -->
                    <div class="dashboard-cards" style="margin-bottom: 30px;">
                        <div class="dashboard-card warning">
                            <div class="card-header">
                                <span class="card-title">å¾…é–“æ¥ä¸»ç®¡å¯©æ ¸</span>
                                <span style="font-size: 24px;">ğŸ‘¥</span>
                            </div>
                            <div class="card-value" id="pendingIndirectCount">0</div>
                        </div>
                        <div class="dashboard-card primary">
                            <div class="card-header">
                                <span class="card-title">å¾…ç›´æ¥ä¸»ç®¡å¯©æ ¸</span>
                                <span style="font-size: 24px;">ğŸ‘¤</span>
                            </div>
                            <div class="card-value" id="pendingDirectCount">0</div>
                        </div>
                        <div class="dashboard-card success">
                            <div class="card-header">
                                <span class="card-title">ä»Šæ—¥å·²å¯©æ ¸</span>
                                <span style="font-size: 24px;">âœ…</span>
                            </div>
                            <div class="card-value" id="todayApprovedCount">0</div>
                        </div>
                        <div class="dashboard-card danger">
                            <div class="card-header">
                                <span class="card-title">é€¾æœŸæœªå¯©æ ¸</span>
                                <span style="font-size: 24px;">â°</span>
                            </div>
                            <div class="card-value" id="overdueCount">0</div>
                        </div>
                    </div>

                    <!-- ç¯©é¸æ¢ä»¶ -->
                    <div class="search-filters">
                        <div class="search-input">
                            <input type="text" id="pendingSearchInput" placeholder="æœç´¢ç”³è«‹äººæˆ–ç”³è«‹èªªæ˜..." onkeyup="filterPendingExpenses()">
                        </div>
                        <div class="form-group">
                            <select id="pendingStatusFilter" onchange="filterPendingExpenses()">
                                <option value="">æ‰€æœ‰å¾…å¯©æ ¸</option>
                                <option value="pending_indirect">å¾…é–“æ¥ä¸»ç®¡å¯©æ ¸</option>
                                <option value="pending_direct">å¾…ç›´æ¥ä¸»ç®¡å¯©æ ¸</option>
                                <option value="pending_ceo">å¾…ç¸½ç¶“ç†å¯©æ ¸</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="pendingDeptFilter" onchange="filterPendingExpenses()">
                                <option value="">æ‰€æœ‰éƒ¨é–€</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="pendingAmountFilter" onchange="filterPendingExpenses()">
                                <option value="">æ‰€æœ‰é‡‘é¡</option>
                                <option value="small">å°é¡ (â‰¤5,000)</option>
                                <option value="medium">ä¸­é¡ (5,001-20,000)</option>
                                <option value="large">å¤§é¡ (>20,000)</option>
                            </select>
                        </div>
                    </div>

                    <!-- å¾…å¯©æ ¸åˆ—è¡¨ -->
                    <div class="table-container">
                        <table id="pendingExpenseTable">
                            <thead>
                                <tr>
                                    <th>ç”³è«‹ç·¨è™Ÿ</th>
                                    <th>ç”³è«‹æ—¥æœŸ</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>éƒ¨é–€</th>
                                    <th>é‡‘é¡</th>
                                    <th>æœƒè¨ˆç§‘ç›®</th>
                                    <th>ç•¶å‰å¯©æ ¸éšæ®µ</th>
                                    <th>å¯©æ ¸äºº</th>
                                    <th>å‰©é¤˜æ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="account" class="tab-content">
                <div class="tab-pane">
                    <h3 style="margin-bottom: 30px; color: #0f4c75;">æœƒè¨ˆç§‘ç›®ç®¡ç†</h3>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="showModal('accountModal')" style="margin-bottom: 20px;">
                            â• æ–°å¢æœƒè¨ˆç§‘ç›®
                        </button>
                        <button class="btn btn-info" onclick="showModal('categoryModal')" style="margin-bottom: 20px;">
                            ğŸ·ï¸ ç®¡ç†ç§‘ç›®åˆ†é¡
                        </button>
                        <button class="btn btn-success" onclick="exportAccounts()" style="margin-bottom: 20px;">
                            ğŸ“Š åŒ¯å‡ºç§‘ç›®æ¸…å–®
                        </button>
                    </div>

                    <!-- ç§‘ç›®åˆ†é¡ç¯©é¸ -->
                    <div class="search-filters">
                        <div class="search-input">
                            <input type="text" id="accountSearchInput" placeholder="æœç´¢ç§‘ç›®ä»£ç¢¼æˆ–åç¨±..." onkeyup="filterAccounts()">
                        </div>
                        <div class="form-group">
                            <select id="categoryFilter" onchange="filterAccounts()">
                                <option value="">æ‰€æœ‰åˆ†é¡</option>
                                <option value="travel">âœˆï¸ å·®æ—…è²»ç”¨</option>
                                <option value="office">ğŸ¢ è¾¦å…¬è²»ç”¨</option>
                                <option value="meal">ğŸ½ï¸ é¤é£²è²»ç”¨</option>
                                <option value="training">ğŸ“š åŸ¹è¨“è²»ç”¨</option>
                                <option value="marketing">ğŸ“¢ è¡ŒéŠ·è²»ç”¨</option>
                                <option value="maintenance">ğŸ”§ ç¶­è­·è²»ç”¨</option>
                                <option value="technology">ğŸ’» ç§‘æŠ€è²»ç”¨</option>
                                <option value="communication">ğŸ“ é€šè¨Šè²»ç”¨</option>
                                <option value="utilities">âš¡ æ°´é›»è²»ç”¨</option>
                                <option value="rent">ğŸ  ç§Ÿè³ƒè²»ç”¨</option>
                                <option value="insurance">ğŸ›¡ï¸ ä¿éšªè²»ç”¨</option>
                                <option value="legal">âš–ï¸ æ³•å¾‹è²»ç”¨</option>
                                <option value="finance">ğŸ’° è²¡å‹™è²»ç”¨</option>
                                <option value="consulting">ğŸ‘¨â€ğŸ’¼ é¡§å•è²»ç”¨</option>
                                <option value="research">ğŸ”¬ ç ”ç™¼è²»ç”¨</option>
                                <option value="entertainment">ğŸ‰ å¨›æ¨‚è²»ç”¨</option>
                                <option value="medical">ğŸ¥ é†«ç™‚è²»ç”¨</option>
                                <option value="transportation">ğŸš› é‹è¼¸è²»ç”¨</option>
                                <option value="security">ğŸ”’ å®‰å…¨è²»ç”¨</option>
                                <option value="other">ğŸ“‹ å…¶ä»–è²»ç”¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="statusFilter" onchange="filterAccounts()">
                                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="normal">âœ… æ­£å¸¸</option>
                                <option value="warning">âš ï¸ è­¦å‘Š</option>
                                <option value="danger">ğŸš¨ è¶…æ”¯</option>
                            </select>
                        </div>
                    </div>

                    <!-- ç§‘ç›®åˆ†é¡çµ±è¨ˆ -->
                    <div class="dashboard-cards" style="margin-bottom: 30px;">
                        <div class="dashboard-card primary">
                            <div class="card-header">
                                <span class="card-title">ç§‘ç›®ç¸½æ•¸</span>
                                <span style="font-size: 24px;">ğŸ“Š</span>
                            </div>
                            <div class="card-value" id="totalAccounts">0</div>
                        </div>
                        <div class="dashboard-card success">
                            <div class="card-header">
                                <span class="card-title">æ­£å¸¸ç§‘ç›®</span>
                                <span style="font-size: 24px;">âœ…</span>
                            </div>
                            <div class="card-value" id="normalAccounts">0</div>
                        </div>
                        <div class="dashboard-card warning">
                            <div class="card-header">
                                <span class="card-title">è­¦å‘Šç§‘ç›®</span>
                                <span style="font-size: 24px;">âš ï¸</span>
                            </div>
                            <div class="card-value" id="warningAccounts">0</div>
                        </div>
                        <div class="dashboard-card danger">
                            <div class="card-header">
                                <span class="card-title">è¶…æ”¯ç§‘ç›®</span>
                                <span style="font-size: 24px;">ğŸš¨</span>
                            </div>
                            <div class="card-value" id="dangerAccounts">0</div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="accountTable">
                            <thead>
                                <tr>
                                    <th>ç§‘ç›®ä»£ç¢¼</th>
                                    <th>ç§‘ç›®åç¨±</th>
                                    <th>åˆ†é¡</th>
                                    <th>é ç®—é¡åº¦</th>
                                    <th>å·²ä½¿ç”¨é¡åº¦</th>
                                    <th>ä½¿ç”¨ç‡</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- éƒ¨é–€ç®¡ç† -->
            <div id="department" class="tab-content">
                <div class="tab-pane">
                    <h3 style="margin-bottom: 30px; color: #0f4c75;">éƒ¨é–€ç®¡ç†</h3>
                    <button class="btn btn-primary" onclick="showModal('departmentModal')" style="margin-bottom: 20px;">
                        â• æ–°å¢éƒ¨é–€
                    </button>
                    
                    <div class="table-container">
                        <table id="departmentTable">
                            <thead>
                                <tr>
                                    <th>éƒ¨é–€ä»£ç¢¼</th>
                                    <th>éƒ¨é–€åç¨±</th>
                                    <th>é–“æ¥ä¸»ç®¡</th>
                                    <th>ç›´æ¥ä¸»ç®¡</th>
                                    <th>é ç®—é¡åº¦</th>
                                    <th>å·²ç”¨é ç®—</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- é ç®—æ§ç®¡ -->
            <div id="budget" class="tab-content">
                <div class="tab-pane">
                    <h3 style="margin-bottom: 30px; color: #0f4c75;">é ç®—æ§ç®¡ç¸½è¦½</h3>
                    <div id="budgetOverview"></div>
                </div>
            </div>

            <!-- æ¸¬è©¦æµç¨‹ -->
            <div id="testing" class="tab-content">
                <div class="tab-pane">
                    <h3 style="margin-bottom: 30px; color: #0f4c75;">æ¸¬è©¦æµç¨‹ç®¡ç†</h3>
                    
                    <div class="budget-alert budget-success">
                        <span style="font-size: 24px;">ğŸ§ª</span>
                        <div>
                            <strong>æ¸¬è©¦æµç¨‹èªªæ˜ï¼š</strong><br>
                            æ¸¬è©¦æµç¨‹ç”¨æ–¼é©—è­‰ç”³è«‹è³‡æ–™çš„å®Œæ•´æ€§å’Œæº–ç¢ºæ€§ï¼ŒåŒ…æ‹¬ï¼šæ ¼å¼æª¢æŸ¥ã€é ç®—é©—è­‰ã€å¯©æ ¸æ¬Šé™ç¢ºèªç­‰ã€‚
                        </div>
                    </div>

                    <div style="margin: 30px 0;">
                        <h4 style="color: #0f4c75; margin-bottom: 20px;">æ¸¬è©¦è¨­å®š</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="testLevel">æ¸¬è©¦ç­‰ç´š</label>
                                <select id="testLevel">
                                    <option value="basic">åŸºæœ¬æ¸¬è©¦</option>
                                    <option value="standard">æ¨™æº–æ¸¬è©¦</option>
                                    <option value="comprehensive">å®Œæ•´æ¸¬è©¦</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="autoTest">è‡ªå‹•æ¸¬è©¦</label>
                                <select id="autoTest">
                                    <option value="enabled">å•Ÿç”¨</option>
                                    <option value="disabled">åœç”¨</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="runSystemTest()">åŸ·è¡Œç³»çµ±æ¸¬è©¦</button>
                    </div>

                    <h4 style="color: #0f4c75; margin: 30px 0 20px 0;">æ¸¬è©¦ä¸­çš„ç”³è«‹</h4>
                    <div class="table-container">
                        <table id="testingTable">
                            <thead>
                                <tr>
                                    <th>ç”³è«‹ç·¨è™Ÿ</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>æ¸¬è©¦éšæ®µ</th>
                                    <th>æ¸¬è©¦çµæœ</th>
                                    <th>é–‹å§‹æ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- æ ¸å‡†æµç¨‹ -->
            <div id="approval" class="tab-content">
                <div class="tab-pane">
                    <h3 style="margin-bottom: 30px; color: #0f4c75;">æ ¸å‡†æµç¨‹ç®¡ç†</h3>
                    
                    <div class="budget-alert budget-warning">
                        <span style="font-size: 24px;">âš¡</span>
                        <div>
                            <strong>æ ¸å‡†æµç¨‹èªªæ˜ï¼š</strong><br>
                            æ ¹æ“šç”³è«‹é‡‘é¡å’Œéƒ¨é–€è¨­å®šï¼Œç³»çµ±æœƒè‡ªå‹•åˆ†é…å°æ‡‰çš„å¯©æ ¸äººå“¡å’Œæµç¨‹ã€‚
                        </div>
                    </div>

                    <!-- æ ¸å‡†æµç¨‹è¨­å®š -->
                    <div style="margin: 30px 0;">
                        <h4 style="color: #0f4c75; margin-bottom: 20px;">æµç¨‹è¨­å®š</h4>
                        <button class="btn btn-primary" onclick="showModal('approvalRuleModal')" style="margin-bottom: 20px;">
                            âš™ï¸ è¨­å®šæ ¸å‡†è¦å‰‡
                        </button>
                        
                        <div class="table-container">
                            <table id="approvalRulesTable">
                                <thead>
                                    <tr>
                                        <th>é‡‘é¡ç¯„åœ</th>
                                        <th>æ ¸å‡†å±¤ç´š</th>
                                        <th>å¯©æ ¸äººå“¡</th>
                                        <th>æ™‚é™ï¼ˆå¤©ï¼‰</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <h4 style="color: #0f4c75; margin: 30px 0 20px 0;">å¾…æ ¸å‡†é …ç›®</h4>
                    <div class="table-container">
                        <table id="approvalTable">
                            <thead>
                                <tr>
                                    <th>ç”³è«‹æ—¥æœŸ</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>éƒ¨é–€</th>
                                    <th>é‡‘é¡</th>
                                    <th>èªªæ˜</th>
                                    <th>å„ªå…ˆç´š</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å ±è¡¨ç®¡ç† -->
            <div id="report" class="tab-content">
                <div class="tab-pane">
                    <h3 style="margin-bottom: 30px; color: #0f4c75;">å ±è¡¨ç®¡ç†</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportType">å ±è¡¨é¡å‹</label>
                            <select id="reportType">
                                <option value="expense">è²»ç”¨ç”³è«‹å ±è¡¨</option>
                                <option value="budget">é ç®—åŸ·è¡Œå ±è¡¨</option>
                                <option value="department">éƒ¨é–€è²»ç”¨å ±è¡¨</option>
                                <option value="approval">æ ¸å‡†æµç¨‹å ±è¡¨</option>
                                <option value="testing">æ¸¬è©¦çµæœå ±è¡¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateRange">å ±è¡¨æœŸé–“</label>
                            <input type="month" id="dateRange">
                        </div>
                        <div class="form-group">
                            <label for="reportFormat">åŒ¯å‡ºæ ¼å¼</label>
                            <select id="reportFormat">
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="csv">CSV (.csv)</option>
                                <option value="pdf">PDF (.pdf)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin: 30px 0; display: flex; gap: 15px;">
                        <button class="btn btn-success" onclick="exportReport()">ğŸ“Š åŒ¯å‡ºå ±è¡¨</button>
                        <button class="btn btn-info" onclick="importData()">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
                        <button class="btn btn-warning" onclick="scheduleReport()">â° æ’ç¨‹å ±è¡¨</button>
                    </div>
                    
                    <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleImport(this.files[0])">
                    
                    <h4 style="color: #0f4c75; margin: 30px 0 20px 0;">å ±è¡¨é è¦½</h4>
                    <div id="reportPreview" style="background: #f8f9fa; padding: 30px; border-radius: 15px; min-height: 200px; text-align: center; color: #666;">
                        è«‹é¸æ“‡å ±è¡¨é¡å‹å’ŒæœŸé–“å¾Œï¼Œé»æ“ŠåŒ¯å‡ºå ±è¡¨æŒ‰éˆ•
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æœƒè¨ˆç§‘ç›®æ¨¡æ…‹æ¡† -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æœƒè¨ˆç§‘ç›®è¨­å®š</h3>
                <span class="close" onclick="closeModal('accountModal')">&times;</span>
            </div>
            <form id="accountForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="accountCodeInput">ç§‘ç›®ä»£ç¢¼ *</label>
                        <input type="text" id="accountCodeInput" placeholder="ä¾‹: 6201" required>
                    </div>
                    <div class="form-group">
                        <label for="accountNameInput">ç§‘ç›®åç¨± *</label>
                        <input type="text" id="accountNameInput" placeholder="ä¾‹: å·®æ—…è²»" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="budgetAmountInput">é ç®—é¡åº¦ (TWD) *</label>
                        <input type="number" id="budgetAmountInput" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="accountCategoryInput">ç§‘ç›®åˆ†é¡</label>
                        <select id="accountCategoryInput">
                            <option value="travel">å·®æ—…è²»ç”¨</option>
                            <option value="office">è¾¦å…¬è²»ç”¨</option>
                            <option value="meal">é¤è²»</option>
                            <option value="training">åŸ¹è¨“è²»ç”¨</option>
                            <option value="other">å…¶ä»–è²»ç”¨</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜</button>
            </form>
        </div>
    </div>

    <!-- éƒ¨é–€æ¨¡æ…‹æ¡† -->
    <div id="departmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">éƒ¨é–€è¨­å®š</h3>
                <span class="close" onclick="closeModal('departmentModal')">&times;</span>
            </div>
            <form id="departmentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="deptCodeInput">éƒ¨é–€ä»£ç¢¼ *</label>
                        <input type="text" id="deptCodeInput" placeholder="ä¾‹: IT" required>
                    </div>
                    <div class="form-group">
                        <label for="deptNameInput">éƒ¨é–€åç¨± *</label>
                        <input type="text" id="deptNameInput" placeholder="ä¾‹: è³‡è¨Šéƒ¨" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="deptManagerInput">ç›´æ¥ä¸»ç®¡ *</label>
                        <input type="text" id="deptManagerInput" placeholder="ä¾‹: å¼µç¶“ç†" required>
                    </div>
                    <div class="form-group">
                        <label for="deptIndirectManagerInput">é–“æ¥ä¸»ç®¡</label>
                        <input type="text" id="deptIndirectManagerInput" placeholder="ä¾‹: æå‰¯ç† (å¯ç©ºç™½)">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="deptBudgetInput">éƒ¨é–€é ç®— (TWD) *</label>
                        <input type="number" id="deptBudgetInput" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="deptDescInput">éƒ¨é–€èªªæ˜</label>
                    <textarea id="deptDescInput" rows="3" placeholder="éƒ¨é–€è·è²¬å’Œèªªæ˜"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜</button>
            </form>
        </div>
    </div>

    <!-- ä½¿ç”¨è€…ç®¡ç†æ¨¡æ…‹æ¡† -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ä½¿ç”¨è€…è¨­å®š</h3>
                <span class="close" onclick="closeModal('userModal')">&times;</span>
            </div>
            <form id="userForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="userUsernameInput">ä½¿ç”¨è€…å¸³è™Ÿ *</label>
                        <input type="text" id="userUsernameInput" placeholder="ä¾‹: john.doe" required pattern="[a-zA-Z0-9._]+" title="åªèƒ½åŒ…å«å­—æ¯ã€æ•¸å­—ã€é»è™Ÿå’Œåº•ç·š">
                    </div>
                    <div class="form-group">
                        <label for="userFullNameInput">å§“å *</label>
                        <input type="text" id="userFullNameInput" placeholder="ä¾‹: ç‹å°æ˜" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userPasswordInput">å¯†ç¢¼ *</label>
                        <input type="password" id="userPasswordInput" placeholder="è‡³å°‘8å€‹å­—å…ƒ" minlength="8" required>
                    </div>
                    <div class="form-group">
                        <label for="userConfirmPasswordInput">ç¢ºèªå¯†ç¢¼ *</label>
                        <input type="password" id="userConfirmPasswordInput" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼" minlength="8" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userRoleInput">è§’è‰² *</label>
                        <select id="userRoleInput" required onchange="updateUserPermissions()">
                            <option value="">è«‹é¸æ“‡è§’è‰²</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userDepartmentInput">éƒ¨é–€ *</label>
                        <select id="userDepartmentInput" required>
                            <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userEmailInput">é›»å­éƒµä»¶ *</label>
                        <input type="email" id="userEmailInput" placeholder="ä¾‹: user@company.com" required>
                    </div>
                    <div class="form-group">
                        <label for="userPhoneInput">é›»è©±è™Ÿç¢¼</label>
                        <input type="tel" id="userPhoneInput" placeholder="ä¾‹: 02-1234-5678">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userStatusInput">å¸³è™Ÿç‹€æ…‹</label>
                        <select id="userStatusInput">
                            <option value="active">âœ… å•Ÿç”¨</option>
                            <option value="inactive">â¸ï¸ åœç”¨</option>
                            <option value="locked">ğŸ”’ é–å®š</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>è§’è‰²æ¬Šé™é è¦½</label>
                    <div id="userPermissionsPreview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 14px; color: #666;">
                        è«‹å…ˆé¸æ“‡è§’è‰²
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜ä½¿ç”¨è€…</button>
            </form>
        </div>
    </div>

    <!-- é™„ä»¶æŸ¥çœ‹æ¨¡æ…‹æ¡† -->
    <div id="attachmentModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“ é™„ä»¶æŸ¥çœ‹</h3>
                <span class="close" onclick="closeModal('attachmentModal')">&times;</span>
            </div>
            
            <div id="attachmentContent">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 id="attachmentExpenseInfo" style="color: #0f4c75;">ç”³è«‹è³‡è¨Š</h4>
                        <div>
                            <button class="btn btn-info" onclick="downloadAllAttachments()" style="margin-right: 10px;">ğŸ“¥ ä¸‹è¼‰å…¨éƒ¨</button>
                            <button class="btn btn-success" onclick="quickApprove()" style="margin-right: 10px;">âœ… å¿«é€Ÿæ ¸å‡†</button>
                            <button class="btn btn-danger" onclick="quickReject()">âŒ å¿«é€Ÿæ‹’çµ•</button>
                        </div>
                    </div>
                    
                    <div id="attachmentSummary" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <!-- ç”³è«‹æ‘˜è¦å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>
                
                <div id="attachmentList">
                    <!-- é™„ä»¶åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                </div>
                
                <div id="noAttachments" style="text-align: center; padding: 40px; color: #666; display: none;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“„</div>
                    <h4>æ­¤ç”³è«‹æ²’æœ‰ä¸Šå‚³é™„ä»¶</h4>
                    <p>ç”³è«‹äººæœªæä¾›ä»»ä½•é™„ä»¶æª”æ¡ˆ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- é™„ä»¶é è¦½æ¨¡æ…‹æ¡† -->
    <div id="attachmentPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; padding: 20px;">
            <div class="modal-header">
                <h3 class="modal-title" id="previewFileName">æª”æ¡ˆé è¦½</h3>
                <span class="close" onclick="closeModal('attachmentPreviewModal')">&times;</span>
            </div>
            
            <div id="previewContent" style="text-align: center; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                <!-- é è¦½å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-info" onclick="downloadCurrentFile()">ğŸ“¥ ä¸‹è¼‰æª”æ¡ˆ</button>
                <button class="btn btn-secondary" onclick="closeModal('attachmentPreviewModal')">é—œé–‰</button>
            </div>
        </div>
    </div>
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è§’è‰²æ¬Šé™ç®¡ç†</h3>
                <span class="close" onclick="closeModal('roleModal')">&times;</span>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h4 style="color: #0f4c75; margin-bottom: 15px;">ç³»çµ±è§’è‰²è¨­å®š</h4>
                <div id="rolesList" style="display: grid; gap: 15px;">
                    <!-- è§’è‰²åˆ—è¡¨å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
            
            <div>
                <h4 style="color: #0f4c75; margin-bottom: 15px;">æ–°å¢è‡ªè¨‚è§’è‰²</h4>
                <form id="roleForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="roleIdInput">è§’è‰²ä»£ç¢¼ *</label>
                            <input type="text" id="roleIdInput" placeholder="ä¾‹: supervisor" required>
                        </div>
                        <div class="form-group">
                            <label for="roleNameInput">è§’è‰²åç¨± *</label>
                            <input type="text" id="roleNameInput" placeholder="ä¾‹: ä¸»ç®¡" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="roleIconInput">è§’è‰²åœ–ç¤º</label>
                        <select id="roleIconInput">
                            <option value="ğŸ‘¤">ğŸ‘¤ ä½¿ç”¨è€…</option>
                            <option value="ğŸ‘¥">ğŸ‘¥ åœ˜éšŠ</option>
                            <option value="ğŸ‘‘">ğŸ‘‘ ç®¡ç†è€…</option>
                            <option value="ğŸ’¼">ğŸ’¼ ä¸»ç®¡</option>
                            <option value="ğŸ›¡ï¸">ğŸ›¡ï¸ å®‰å…¨</option>
                            <option value="ğŸ”§">ğŸ”§ æŠ€è¡“</option>
                            <option value="ğŸ“Š">ğŸ“Š åˆ†æ</option>
                            <option value="ğŸ’°">ğŸ’° è²¡å‹™</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ¬Šé™è¨­å®š</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="rolePermissions" value="all"> å®Œæ•´æ¬Šé™
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="rolePermissions" value="create"> å»ºç«‹ç”³è«‹
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="rolePermissions" value="view"> æª¢è¦–è³‡æ–™
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="rolePermissions" value="approve"> æ ¸å‡†ç”³è«‹
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="rolePermissions" value="budget"> é ç®—ç®¡ç†
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="rolePermissions" value="testing"> æ¸¬è©¦åŠŸèƒ½
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="rolePermissions" value="account_manage"> ç§‘ç›®ç®¡ç†
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="roleDescInput">è§’è‰²èªªæ˜</label>
                        <textarea id="roleDescInput" rows="2" placeholder="è§’è‰²è·è²¬å’Œæ¬Šé™èªªæ˜"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">â• æ–°å¢è§’è‰²</button>
                </form>
            </div>
        </div>
    </div>
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç§‘ç›®åˆ†é¡ç®¡ç†</h3>
                <span class="close" onclick="closeModal('categoryModal')">&times;</span>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h4 style="color: #0f4c75; margin-bottom: 15px;">æ–°å¢åˆ†é¡</h4>
                <form id="categoryForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="categoryIdInput">åˆ†é¡ä»£ç¢¼ *</label>
                            <input type="text" id="categoryIdInput" placeholder="ä¾‹: tech" required>
                        </div>
                        <div class="form-group">
                            <label for="categoryNameInput">åˆ†é¡åç¨± *</label>
                            <input type="text" id="categoryNameInput" placeholder="ä¾‹: æŠ€è¡“è²»ç”¨" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="categoryIconInput">åœ–ç¤º</label>
                            <select id="categoryIconInput">
                                <option value="ğŸ“Š">ğŸ“Š åœ–è¡¨åˆ†æ</option>
                                <option value="ğŸ’¼">ğŸ’¼ å•†å‹™å…¬äº‹</option>
                                <option value="ğŸ–¥ï¸">ğŸ–¥ï¸ é›»è…¦è¨­å‚™</option>
                                <option value="ğŸ“±">ğŸ“± è¡Œå‹•è£ç½®</option>
                                <option value="ğŸ”§">ğŸ”§ ç¶­ä¿®å·¥å…·</option>
                                <option value="ğŸ“š">ğŸ“š æ•™è‚²åŸ¹è¨“</option>
                                <option value="ğŸš—">ğŸš— äº¤é€šé‹è¼¸</option>
                                <option value="ğŸ ">ğŸ  æˆ¿å±‹ç§Ÿè³ƒ</option>
                                <option value="âš¡">âš¡ æ°´é›»èƒ½æº</option>
                                <option value="ğŸŒ">ğŸŒ ç¶²è·¯é€šè¨Š</option>
                                <option value="ğŸ’°">ğŸ’° é‡‘èè²¡å‹™</option>
                                <option value="ğŸ›¡ï¸">ğŸ›¡ï¸ ä¿éšªå®‰å…¨</option>
                                <option value="âš–ï¸">âš–ï¸ æ³•å¾‹äº‹å‹™</option>
                                <option value="ğŸ‰">ğŸ‰ æ´»å‹•å¨›æ¨‚</option>
                                <option value="ğŸ¥">ğŸ¥ é†«ç™‚å¥åº·</option>
                                <option value="ğŸ”¬">ğŸ”¬ ç ”ç©¶é–‹ç™¼</option>
                                <option value="ğŸ“¢">ğŸ“¢ è¡ŒéŠ·å®£å‚³</option>
                                <option value="ğŸ‘¨â€ğŸ’¼">ğŸ‘¨â€ğŸ’¼ å°ˆæ¥­é¡§å•</option>
                                <option value="ğŸš›">ğŸš› ç‰©æµé‹é€</option>
                                <option value="ğŸ”’">ğŸ”’ è³‡å®‰é˜²è­·</option>
                                <option value="ğŸ“">ğŸ“ é€šè¨Šè¯çµ¡</option>
                                <option value="âœˆï¸">âœˆï¸ å·®æ—…å‡ºå·®</option>
                                <option value="ğŸ½ï¸">ğŸ½ï¸ é¤é£²ç”¨è†³</option>
                                <option value="ğŸ’»">ğŸ’» ç§‘æŠ€è³‡è¨Š</option>
                                <option value="ğŸ“‹">ğŸ“‹ å…¶ä»–é›œé …</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="categoryColorInput">é¡è‰²</label>
                            <select id="categoryColorInput">
                                <option value="#007bff" style="color: #007bff;">ğŸ”µ è—è‰²</option>
                                <option value="#28a745" style="color: #28a745;">ğŸŸ¢ ç¶ è‰²</option>
                                <option value="#ffc107" style="color: #ffc107;">ğŸŸ¡ é»ƒè‰²</option>
                                <option value="#dc3545" style="color: #dc3545;">ğŸ”´ ç´…è‰²</option>
                                <option value="#17a2b8" style="color: #17a2b8;">ğŸŸ¦ é’è‰²</option>
                                <option value="#6f42c1" style="color: #6f42c1;">ğŸŸ£ ç´«è‰²</option>
                                <option value="#fd7e14" style="color: #fd7e14;">ğŸŸ  æ©™è‰²</option>
                                <option value="#e83e8c" style="color: #e83e8c;">ğŸ©· ç²‰è‰²</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="categoryDescInput">åˆ†é¡èªªæ˜</label>
                        <textarea id="categoryDescInput" rows="2" placeholder="åˆ†é¡ç”¨é€”èªªæ˜"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">â• æ–°å¢åˆ†é¡</button>
                </form>
            </div>
            
            <div>
                <h4 style="color: #0f4c75; margin-bottom: 15px;">ç¾æœ‰åˆ†é¡</h4>
                <div id="categoriesList" style="display: grid; gap: 15px;">
                    <!-- åˆ†é¡åˆ—è¡¨å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </div>
    <div id="approvalRuleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ ¸å‡†è¦å‰‡è¨­å®š</h3>
                <span class="close" onclick="closeModal('approvalRuleModal')">&times;</span>
            </div>
            <form id="approvalRuleForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="minAmountInput">æœ€å°é‡‘é¡ (TWD)</label>
                        <input type="number" id="minAmountInput" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="maxAmountInput">æœ€å¤§é‡‘é¡ (TWD)</label>
                        <input type="number" id="maxAmountInput" placeholder="99999999.99" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="approverInput">å¯©æ ¸äººå“¡</label>
                        <input type="text" id="approverInput" placeholder="å¯©æ ¸äººå“¡å§“å" required>
                    </div>
                    <div class="form-group">
                        <label for="approvalLevelInput">æ ¸å‡†å±¤ç´š</label>
                        <select id="approvalLevelInput" required>
                            <option value="1">ç¬¬ä¸€å±¤ - éƒ¨é–€ä¸»ç®¡</option>
                            <option value="2">ç¬¬äºŒå±¤ - éƒ¨é–€ç¶“ç†</option>
                            <option value="3">ç¬¬ä¸‰å±¤ - ç¸½ç¶“ç†</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="timeLimitInput">å¯©æ ¸æ™‚é™ï¼ˆå¤©ï¼‰</label>
                        <input type="number" id="timeLimitInput" placeholder="3" min="1" max="30" required>
                    </div>
                    <div class="form-group">
                        <label for="autoEscalateInput">è‡ªå‹•å‡ç´š</label>
                        <select id="autoEscalateInput">
                            <option value="yes">æ˜¯</option>
                            <option value="no">å¦</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜è¦å‰‡</button>
            </form>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let expenses = [];
        let accounts = [
            { code: '6201', name: 'å·®æ—…è²»', budget: 120000, used: 25000, category: 'travel', description: 'å“¡å·¥å‡ºå·®äº¤é€šä½å®¿è²»ç”¨', status: 'active' },
            { code: '6202', name: 'å¸‚å…§äº¤é€šè²»', budget: 45000, used: 15000, category: 'travel', description: 'å¸‚å…§å…¬å‹™äº¤é€šè²»ç”¨', status: 'active' },
            { code: '6203', name: 'å“¡å·¥é¤è²»', budget: 60000, used: 28000, category: 'meal', description: 'å“¡å·¥å·¥ä½œé¤é»è²»ç”¨', status: 'active' },
            { code: '6204', name: 'è¾¦å…¬ç”¨å“', budget: 35000, used: 12000, category: 'office', description: 'æ–‡å…·ã€ç´™å¼µç­‰è¾¦å…¬ç”¨å“', status: 'active' },
            { code: '6205', name: 'å“¡å·¥åŸ¹è¨“', budget: 80000, used: 35000, category: 'training', description: 'å“¡å·¥æŠ€èƒ½åŸ¹è¨“èª²ç¨‹è²»ç”¨', status: 'active' },
            { code: '6206', name: 'å»£å‘Šå®£å‚³', budget: 150000, used: 95000, category: 'marketing', description: 'å»£å‘ŠæŠ•æ”¾èˆ‡å®£å‚³è²»ç”¨', status: 'active' },
            { code: '6207', name: 'è¨­å‚™ç¶­è­·', budget: 70000, used: 52000, category: 'maintenance', description: 'è¾¦å…¬è¨­å‚™ä¿é¤Šç¶­ä¿®è²»ç”¨', status: 'active' },
            { code: '6208', name: 'è»Ÿé«”æˆæ¬Š', budget: 100000, used: 75000, category: 'technology', description: 'è»Ÿé«”æˆæ¬Šèˆ‡é›²ç«¯æœå‹™è²»ç”¨', status: 'active' },
            { code: '6209', name: 'é›»è©±ç¶²è·¯', budget: 40000, used: 18000, category: 'communication', description: 'é›»è©±è²»èˆ‡ç¶²è·¯ä½¿ç”¨è²»', status: 'active' },
            { code: '6210', name: 'æ°´é›»è²»', budget: 90000, used: 45000, category: 'utilities', description: 'è¾¦å…¬å®¤æ°´é›»ç“¦æ–¯è²»ç”¨', status: 'active' },
            { code: '6211', name: 'è¾¦å…¬å®¤ç§Ÿé‡‘', budget: 300000, used: 150000, category: 'rent', description: 'è¾¦å…¬ç©ºé–“ç§Ÿè³ƒè²»ç”¨', status: 'active' },
            { code: '6212', name: 'å•†æ¥­ä¿éšª', budget: 50000, used: 25000, category: 'insurance', description: 'ä¼æ¥­è²¬ä»»éšªç­‰ä¿éšªè²»ç”¨', status: 'active' },
            { code: '6213', name: 'æ³•å¾‹æœå‹™', budget: 60000, used: 15000, category: 'legal', description: 'æ³•å¾‹è«®è©¢èˆ‡åˆç´„å¯©æŸ¥', status: 'active' },
            { code: '6214', name: 'éŠ€è¡Œæ‰‹çºŒè²»', budget: 25000, used: 8000, category: 'finance', description: 'éŠ€è¡Œè½‰å¸³èˆ‡é‡‘èæœå‹™è²»', status: 'active' },
            { code: '6215', name: 'ç®¡ç†é¡§å•', budget: 120000, used: 40000, category: 'consulting', description: 'å¤–éƒ¨é¡§å•èˆ‡å°ˆæ¥­æœå‹™', status: 'active' }
        ];
        
        let accountCategories = [
            { id: 'travel', name: 'å·®æ—…è²»ç”¨', icon: 'âœˆï¸', color: '#007bff', description: 'å“¡å·¥å‡ºå·®ã€äº¤é€šã€ä½å®¿ç­‰ç›¸é—œè²»ç”¨' },
            { id: 'office', name: 'è¾¦å…¬è²»ç”¨', icon: 'ğŸ¢', color: '#28a745', description: 'è¾¦å…¬å®¤ç”¨å“ã€æ–‡å…·ã€è¨­å‚™ç­‰è²»ç”¨' },
            { id: 'meal', name: 'é¤é£²è²»ç”¨', icon: 'ğŸ½ï¸', color: '#ffc107', description: 'å“¡å·¥ç”¨é¤ã€å®¢æˆ¶æ‹›å¾…ã€æœƒè­°é¤é»ç­‰è²»ç”¨' },
            { id: 'training', name: 'åŸ¹è¨“è²»ç”¨', icon: 'ğŸ“š', color: '#17a2b8', description: 'å“¡å·¥åŸ¹è¨“ã€ç ”ç¿’ã€è­‰ç…§è€ƒè©¦ç­‰è²»ç”¨' },
            { id: 'marketing', name: 'è¡ŒéŠ·è²»ç”¨', icon: 'ğŸ“¢', color: '#fd7e14', description: 'å»£å‘Šå®£å‚³ã€å¸‚å ´æ¨å»£ã€æ´»å‹•è²»ç”¨' },
            { id: 'maintenance', name: 'ç¶­è­·è²»ç”¨', icon: 'ğŸ”§', color: '#6f42c1', description: 'è¨­å‚™ä¿é¤Šã€ç¶­ä¿®ã€æ¸…æ½”ç­‰è²»ç”¨' },
            { id: 'technology', name: 'ç§‘æŠ€è²»ç”¨', icon: 'ğŸ’»', color: '#20c997', description: 'è»Ÿé«”æˆæ¬Šã€é›²ç«¯æœå‹™ã€ITè¨­å‚™ç­‰è²»ç”¨' },
            { id: 'communication', name: 'é€šè¨Šè²»ç”¨', icon: 'ğŸ“', color: '#e83e8c', description: 'é›»è©±è²»ã€ç¶²è·¯è²»ã€éƒµå¯„è²»ç­‰é€šè¨Šè²»ç”¨' },
            { id: 'utilities', name: 'æ°´é›»è²»ç”¨', icon: 'âš¡', color: '#fd7e14', description: 'é›»è²»ã€æ°´è²»ã€ç“¦æ–¯è²»ç­‰å…¬å…±äº‹æ¥­è²»ç”¨' },
            { id: 'rent', name: 'ç§Ÿè³ƒè²»ç”¨', icon: 'ğŸ ', color: '#6c757d', description: 'è¾¦å…¬å®¤ç§Ÿé‡‘ã€è¨­å‚™ç§Ÿè³ƒç­‰è²»ç”¨' },
            { id: 'insurance', name: 'ä¿éšªè²»ç”¨', icon: 'ğŸ›¡ï¸', color: '#dc3545', description: 'å•†æ¥­ä¿éšªã€è²¬ä»»ä¿éšªç­‰è²»ç”¨' },
            { id: 'legal', name: 'æ³•å¾‹è²»ç”¨', icon: 'âš–ï¸', color: '#495057', description: 'å¾‹å¸«è²»ã€æ³•å¾‹è«®è©¢ã€åˆç´„å¯©æŸ¥ç­‰è²»ç”¨' },
            { id: 'finance', name: 'è²¡å‹™è²»ç”¨', icon: 'ğŸ’°', color: '#ffc107', description: 'éŠ€è¡Œæ‰‹çºŒè²»ã€åˆ©æ¯ã€æœƒè¨ˆæœå‹™ç­‰è²»ç”¨' },
            { id: 'consulting', name: 'é¡§å•è²»ç”¨', icon: 'ğŸ‘¨â€ğŸ’¼', color: '#6610f2', description: 'ç®¡ç†é¡§å•ã€å°ˆæ¥­è«®è©¢ç­‰è²»ç”¨' },
            { id: 'research', name: 'ç ”ç™¼è²»ç”¨', icon: 'ğŸ”¬', color: '#20c997', description: 'ç ”ç©¶é–‹ç™¼ã€å¯¦é©—ææ–™ã€å°ˆåˆ©ç”³è«‹ç­‰è²»ç”¨' },
            { id: 'entertainment', name: 'å¨›æ¨‚è²»ç”¨', icon: 'ğŸ‰', color: '#e83e8c', description: 'å“¡å·¥èšé¤ã€å°¾ç‰™ã€åœ˜å»ºæ´»å‹•ç­‰è²»ç”¨' },
            { id: 'medical', name: 'é†«ç™‚è²»ç”¨', icon: 'ğŸ¥', color: '#dc3545', description: 'å“¡å·¥å¥æª¢ã€æ€¥æ•‘ç”¨å“ã€é†«ç™‚ä¿å¥ç­‰è²»ç”¨' },
            { id: 'transportation', name: 'é‹è¼¸è²»ç”¨', icon: 'ğŸš›', color: '#fd7e14', description: 'è²¨é‹ã€å¿«éã€ç‰©æµç­‰é‹è¼¸è²»ç”¨' },
            { id: 'security', name: 'å®‰å…¨è²»ç”¨', icon: 'ğŸ”’', color: '#495057', description: 'ä¿å…¨ã€ç›£æ§ç³»çµ±ã€å®‰å…¨è¨­å‚™ç­‰è²»ç”¨' },
            { id: 'other', name: 'å…¶ä»–è²»ç”¨', icon: 'ğŸ“‹', color: '#6c757d', description: 'å…¶ä»–æœªåˆ†é¡çš„é›¶æ˜Ÿè²»ç”¨' }
        ];
        
        let departments = [
            { code: 'IT', name: 'è³‡è¨Šéƒ¨', manager: 'å¼µç¶“ç†', indirectManager: 'æå‰¯ç†', budget: 200000, used: 45000, desc: 'è² è²¬å…¬å¸è³‡è¨Šç³»çµ±é–‹ç™¼èˆ‡ç¶­è­·' },
            { code: 'HR', name: 'äººäº‹éƒ¨', manager: 'æç¶“ç†', indirectManager: '', budget: 150000, used: 30000, desc: 'è² è²¬äººåŠ›è³‡æºç®¡ç†èˆ‡æ‹›å‹Ÿ' },
            { code: 'FIN', name: 'è²¡å‹™éƒ¨', manager: 'ç‹ç¶“ç†', indirectManager: 'é™³å‰¯ç†', budget: 100000, used: 25000, desc: 'è² è²¬è²¡å‹™ç®¡ç†èˆ‡æœƒè¨ˆä½œæ¥­' },
            { code: 'MKT', name: 'è¡ŒéŠ·éƒ¨', manager: 'é™³ç¶“ç†', indirectManager: 'æ—å‰¯ç†', budget: 300000, used: 85000, desc: 'è² è²¬å¸‚å ´è¡ŒéŠ·èˆ‡å“ç‰Œæ¨å»£' },
            { code: 'RD', name: 'ç ”ç™¼éƒ¨', manager: 'æ—ç¶“ç†', indirectManager: 'é»ƒå‰¯ç†', budget: 250000, used: 60000, desc: 'è² è²¬ç”¢å“ç ”ç™¼èˆ‡æŠ€è¡“å‰µæ–°' }
        ];
        
        let approvalRules = [
            { minAmount: 0, maxAmount: 5000, level: 1, approver: 'é–“æ¥ä¸»ç®¡/ç›´æ¥ä¸»ç®¡', timeLimit: 2, autoEscalate: 'yes' },
            { minAmount: 5001, maxAmount: 20000, level: 2, approver: 'ç›´æ¥ä¸»ç®¡', timeLimit: 3, autoEscalate: 'yes' },
            { minAmount: 20001, maxAmount: 999999999, level: 3, approver: 'ç¸½ç¶“ç†', timeLimit: 5, autoEscalate: 'no' }
        ];
        
        // æ¸¬è©¦å¸³è™Ÿè³‡æ–™
        let testAccounts = [
            { 
                username: 'admin', 
                password: 'admin123', 
                role: 'ç³»çµ±ç®¡ç†å“¡', 
                department: 'IT', 
                permissions: ['all'],
                fullName: 'ç³»çµ±ç®¡ç†å“¡',
                email: 'admin@company.com',
                phone: '02-1234-5678',
                status: 'active',
                lastLogin: '2024-01-20 09:00:00',
                createdDate: '2024-01-01',
                createdBy: 'system'
            },
            { 
                username: 'manager', 
                password: 'manager123', 
                role: 'éƒ¨é–€ç¶“ç†', 
                department: 'IT', 
                permissions: ['approve', 'view', 'create'],
                fullName: 'å¼µç¶“ç†',
                email: 'manager@company.com',
                phone: '02-1234-5679',
                status: 'active',
                lastLogin: '2024-01-20 08:30:00',
                createdDate: '2024-01-01',
                createdBy: 'admin'
            },
            { 
                username: 'user01', 
                password: 'user123', 
                role: 'ä¸€èˆ¬å“¡å·¥', 
                department: 'IT', 
                permissions: ['create', 'view'],
                fullName: 'ç‹å°æ˜',
                email: 'user01@company.com',
                phone: '02-1234-5680',
                status: 'active',
                lastLogin: '2024-01-19 17:45:00',
                createdDate: '2024-01-05',
                createdBy: 'admin'
            },
            { 
                username: 'finance', 
                password: 'finance123', 
                role: 'è²¡å‹™äººå“¡', 
                department: 'FIN', 
                permissions: ['budget', 'view', 'approve'],
                fullName: 'é™³æœƒè¨ˆ',
                email: 'finance@company.com',
                phone: '02-1234-5681',
                status: 'active',
                lastLogin: '2024-01-20 08:15:00',
                createdDate: '2024-01-01',
                createdBy: 'admin'
            },
            { 
                username: 'hr', 
                password: 'hr123', 
                role: 'ä¸€èˆ¬å“¡å·¥', 
                department: 'HR', 
                permissions: ['create', 'view'],
                fullName: 'æå°è¯',
                email: 'hr@company.com',
                phone: '02-1234-5682',
                status: 'active',
                lastLogin: '2024-01-19 16:20:00',
                createdDate: '2024-01-10',
                createdBy: 'admin'
            },
            { 
                username: 'marketing', 
                password: 'mkt123', 
                role: 'ä¸€èˆ¬å“¡å·¥', 
                department: 'MKT', 
                permissions: ['create', 'view'],
                fullName: 'æ—è¡ŒéŠ·',
                email: 'marketing@company.com',
                phone: '02-1234-5683',
                status: 'active',
                lastLogin: '2024-01-18 18:30:00',
                createdDate: '2024-01-15',
                createdBy: 'manager'
            },
            { 
                username: 'rd', 
                password: 'rd123', 
                role: 'ä¸€èˆ¬å“¡å·¥', 
                department: 'RD', 
                permissions: ['create', 'view'],
                fullName: 'é»ƒå·¥ç¨‹å¸«',
                email: 'rd@company.com',
                phone: '02-1234-5684',
                status: 'active',
                lastLogin: '2024-01-20 07:45:00',
                createdDate: '2024-01-12',
                createdBy: 'admin'
            },
            { 
                username: 'ceo', 
                password: 'ceo123', 
                role: 'ç¸½ç¶“ç†', 
                department: 'CEO', 
                permissions: ['all'],
                fullName: 'è‘£ç¸½ç¶“ç†',
                email: 'ceo@company.com',
                phone: '02-1234-5685',
                status: 'active',
                lastLogin: '2024-01-19 09:15:00',
                createdDate: '2024-01-01',
                createdBy: 'system'
            },
            { 
                username: 'test', 
                password: 'test123', 
                role: 'æ¸¬è©¦äººå“¡', 
                department: 'IT', 
                permissions: ['testing', 'view'],
                fullName: 'æ¸¬è©¦äººå“¡',
                email: 'test@company.com',
                phone: '02-1234-5686',
                status: 'active',
                lastLogin: '2024-01-20 10:30:00',
                createdDate: '2024-01-08',
                createdBy: 'admin'
            },
            { 
                username: 'disabled_user', 
                password: 'disabled123', 
                role: 'ä¸€èˆ¬å“¡å·¥', 
                department: 'IT', 
                permissions: ['create', 'view'],
                fullName: 'å·²åœç”¨ä½¿ç”¨è€…',
                email: 'disabled@company.com',
                phone: '02-1234-5687',
                status: 'inactive',
                lastLogin: '2024-01-10 15:20:00',
                createdDate: '2024-01-01',
                createdBy: 'admin'
            }
        ];
        
        let userRoles = [
            {
                id: 'admin',
                name: 'ç³»çµ±ç®¡ç†å“¡',
                icon: 'ğŸ‘‘',
                permissions: ['all'],
                description: 'æ“æœ‰ç³»çµ±å®Œæ•´æ¬Šé™ï¼Œå¯ç®¡ç†æ‰€æœ‰åŠŸèƒ½'
            },
            {
                id: 'manager',
                name: 'éƒ¨é–€ç¶“ç†',
                icon: 'ğŸ‘¤',
                permissions: ['approve', 'view', 'create', 'budget'],
                description: 'å¯å¯©æ ¸ç”³è«‹ã€ç®¡ç†éƒ¨é–€é ç®—ã€æª¢è¦–å ±è¡¨'
            },
            {
                id: 'finance',
                name: 'è²¡å‹™äººå“¡',
                icon: 'ğŸ’°',
                permissions: ['budget', 'view', 'approve', 'account_manage'],
                description: 'ç®¡ç†é ç®—ã€æœƒè¨ˆç§‘ç›®ã€å¯©æ ¸è²¡å‹™ç›¸é—œç”³è«‹'
            },
            {
                id: 'ceo',
                name: 'ç¸½ç¶“ç†',
                icon: 'ğŸ†',
                permissions: ['all'],
                description: 'æœ€é«˜æ±ºç­–è€…ï¼Œæ“æœ‰å®Œæ•´ç³»çµ±æ¬Šé™'
            },
            {
                id: 'tester',
                name: 'æ¸¬è©¦äººå“¡',
                icon: 'ğŸ§ª',
                permissions: ['testing', 'view'],
                description: 'è² è²¬ç³»çµ±æ¸¬è©¦ã€æµç¨‹é©—è­‰'
            },
            {
                id: 'employee',
                name: 'ä¸€èˆ¬å“¡å·¥',
                icon: 'ğŸ‘·',
                permissions: ['create', 'view'],
                description: 'å¯æäº¤è²»ç”¨ç”³è«‹ã€æª¢è¦–å€‹äººè¨˜éŒ„'
            }
        ];
        
        let uploadedFiles = [];
        let currentUser = '';
        let currentUserRole = '';
        let currentUserDept = '';
        let currentUserPermissions = [];
        let currentAttachmentExpenseId = null; // ç•¶å‰æŸ¥çœ‹é™„ä»¶çš„ç”³è«‹ID

        // å¿«é€Ÿç™»å…¥åŠŸèƒ½
        function quickLogin(username, password) {
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
            document.getElementById('loginForm').dispatchEvent(new Event('submit'));
        }

        // ç™»å…¥åŠŸèƒ½
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            console.log('å˜—è©¦ç™»å…¥:', username, password); // é™¤éŒ¯ç”¨
            
            // æª¢æŸ¥æ¸¬è©¦å¸³è™Ÿ
            const testAccount = testAccounts.find(acc => 
                acc.username.toLowerCase() === username.toLowerCase() && 
                acc.password === password
            );
            
            console.log('æ‰¾åˆ°æ¸¬è©¦å¸³è™Ÿ:', testAccount); // é™¤éŒ¯ç”¨
            
            if (testAccount) {
                currentUser = testAccount.username;
                currentUserRole = testAccount.role;
                currentUserDept = testAccount.department;
                currentUserPermissions = testAccount.permissions;
                
                console.log('è¨­å®šä½¿ç”¨è€…è³‡æ–™:', currentUser, currentUserRole); // é™¤éŒ¯ç”¨
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                document.getElementById('currentUser').innerHTML = `
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: #0f4c75;">${testAccount.username}</div>
                        <div style="font-size: 12px; color: #666;">${testAccount.role} - ${testAccount.department}</div>
                    </div>
                `;
                
                try {
                    initializeSystem();
                    
                    // ç¢ºä¿å„€è¡¨æ¿æ¨™ç±¤è¢«æ¿€æ´»
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active');
                    });
                    
                    // é¡¯ç¤ºå„€è¡¨æ¿
                    document.getElementById('dashboard').style.display = 'block';
                    document.querySelector('#dashboard .tab-pane').classList.add('active');
                    document.querySelector('[onclick="showTab(\'dashboard\')"]').classList.add('active');
                    
                    // æ ¹æ“šæ¬Šé™é¡¯ç¤ºåŠŸèƒ½
                    applyPermissions();
                    
                    // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
                    setTimeout(() => {
                        alert(`æ­¡è¿ ${testAccount.role} ${username}ï¼\néƒ¨é–€ï¼š${testAccount.department}\n\nå¯ç”¨åŠŸèƒ½ï¼š${getPermissionDescription(testAccount.permissions)}`);
                    }, 500);
                    
                } catch(error) {
                    console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                    alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
                
            } else if (username && password) {
                // ä¸€èˆ¬å¸³è™Ÿï¼ˆåŸæœ‰é‚è¼¯ï¼‰
                currentUser = username;
                currentUserRole = 'ä¸€èˆ¬ä½¿ç”¨è€…';
                currentUserDept = 'IT';
                currentUserPermissions = ['create', 'view'];
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                document.getElementById('currentUser').innerHTML = `
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: #0f4c75;">${username}</div>
                        <div style="font-size: 12px; color: #666;">ä¸€èˆ¬ä½¿ç”¨è€… - IT</div>
                    </div>
                `;
                
                try {
                    initializeSystem();
                    
                    // é¡¯ç¤ºå„€è¡¨æ¿
                    document.getElementById('dashboard').style.display = 'block';
                    document.querySelector('#dashboard .tab-pane').classList.add('active');
                    document.querySelector('[onclick="showTab(\'dashboard\')"]').classList.add('active');
                    
                } catch(error) {
                    console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                    alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
            } else {
                alert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼ï¼\n\nğŸ’¡ æ¸¬è©¦å¸³è™Ÿåƒè€ƒï¼š\nâ€¢ admin / admin123 (ç³»çµ±ç®¡ç†å“¡)\nâ€¢ manager / manager123 (éƒ¨é–€ç¶“ç†)\nâ€¢ user01 / user123 (ä¸€èˆ¬å“¡å·¥)\nâ€¢ finance / finance123 (è²¡å‹™äººå“¡)\nâ€¢ test / test123 (æ¸¬è©¦äººå“¡)');
            }
        });

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainInterface').style.display = 'none';
                document.getElementById('loginForm').reset();
                currentUser = '';
                currentUserRole = '';
                currentUserDept = '';
                currentUserPermissions = [];
                
                // é‡ç½®æ¬Šé™é¡¯ç¤º
                resetPermissions();
            }
        }

        // æ¬Šé™ç®¡ç†åŠŸèƒ½
        function applyPermissions() {
            const navTabs = document.querySelectorAll('.nav-tab');
            
            // éš±è—æ‰€æœ‰æ¨™ç±¤
            navTabs.forEach(tab => {
                tab.style.display = 'none';
            });
            
            // æ ¹æ“šæ¬Šé™é¡¯ç¤ºæ¨™ç±¤
            if (hasPermission('all') || hasPermission('view')) {
                document.querySelector('[onclick="showTab(\'dashboard\')"]').style.display = 'block';
            }
            
            if (hasPermission('all') || hasPermission('create')) {
                document.querySelector('[onclick="showTab(\'expense\')"]').style.display = 'block';
            }
            
            if (hasPermission('all') || currentUserRole === 'ç³»çµ±ç®¡ç†å“¡' || currentUserRole === 'è²¡å‹™äººå“¡') {
                document.querySelector('[onclick="showTab(\'account\')"]').style.display = 'block';
                document.querySelector('[onclick="showTab(\'department\')"]').style.display = 'block';
            }
            
            if (hasPermission('all') || hasPermission('budget') || currentUserRole === 'è²¡å‹™äººå“¡') {
                document.querySelector('[onclick="showTab(\'budget\')"]').style.display = 'block';
            }
            
            if (hasPermission('all') || hasPermission('testing') || currentUserRole === 'æ¸¬è©¦äººå“¡') {
                document.querySelector('[onclick="showTab(\'testing\')"]').style.display = 'block';
            }
            
            if (hasPermission('all') || hasPermission('approve') || currentUserRole === 'éƒ¨é–€ç¶“ç†' || currentUserRole === 'ç¸½ç¶“ç†') {
                document.querySelector('[onclick="showTab(\'approval\')"]').style.display = 'block';
            }
            
            if (hasPermission('all') || currentUserRole === 'ç³»çµ±ç®¡ç†å“¡' || currentUserRole === 'è²¡å‹™äººå“¡') {
                document.querySelector('[onclick="showTab(\'report\')"]').style.display = 'block';
            }
        }

        function resetPermissions() {
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.style.display = 'block';
            });
        }

        function hasPermission(permission) {
            return currentUserPermissions.includes(permission);
        }

        function getPermissionDescription(permissions) {
            const permissionMap = {
                'all': 'å®Œæ•´æ¬Šé™',
                'create': 'å»ºç«‹ç”³è«‹',
                'view': 'æª¢è¦–è³‡æ–™',
                'approve': 'æ ¸å‡†ç”³è«‹',
                'budget': 'é ç®—ç®¡ç†',
                'testing': 'æ¸¬è©¦åŠŸèƒ½'
            };
            
            if (permissions.includes('all')) {
                return 'å®Œæ•´ç³»çµ±æ¬Šé™';
            }
            
            return permissions.map(p => permissionMap[p] || p).join('ã€');
        }

        // ç³»çµ±åˆå§‹åŒ–
        function initializeSystem() {
            console.log('é–‹å§‹åˆå§‹åŒ–ç³»çµ±...'); // é™¤éŒ¯ç”¨
            
            try {
                loadAccounts();
                console.log('æœƒè¨ˆç§‘ç›®è¼‰å…¥å®Œæˆ');
                
                loadDepartments();
                console.log('éƒ¨é–€è³‡æ–™è¼‰å…¥å®Œæˆ');
                
                loadExpenses();
                console.log('è²»ç”¨è¨˜éŒ„è¼‰å…¥å®Œæˆ');
                
                loadBudgetOverview();
                console.log('é ç®—ç¸½è¦½è¼‰å…¥å®Œæˆ');
                
                loadApprovalRules();
                console.log('æ ¸å‡†è¦å‰‡è¼‰å…¥å®Œæˆ');
                
                updateDashboard();
                console.log('å„€è¡¨æ¿æ›´æ–°å®Œæˆ');
                
                updateLastUpdate();
                console.log('æ™‚é–“æ›´æ–°å®Œæˆ');
                
                // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•¸æ“š
                if (expenses.length === 0) {
                    expenses = [
                        {
                            id: 1001,
                            date: '2024-01-15',
                            applicant: 'ç‹å°æ˜',
                            applicantDept: 'IT',
                            accountCode: '6201',
                            salesAmount: 4762,
                            taxRate: 5,
                            inputTax: 238,
                            amount: 5000,
                            description: 'å°åŒ—å‡ºå·®äº¤é€šè²»',
                            status: 'approved',
                            files: [
                                {
                                    name: 'å‡ºå·®ç”³è«‹å–®.pdf',
                                    size: 245760,
                                    type: 'application/pdf',
                                    uploadDate: '2024-01-15T08:30:00.000Z'
                                },
                                {
                                    name: 'äº¤é€šè²»æ”¶æ“š.jpg',
                                    size: 156432,
                                    type: 'image/jpeg',
                                    uploadDate: '2024-01-15T08:35:00.000Z'
                                }
                            ]
                        },
                        {
                            id: 1002,
                            date: '2024-01-16',
                            applicant: 'æå°è¯',
                            applicantDept: 'MKT',
                            accountCode: '6203',
                            salesAmount: 1143,
                            taxRate: 5,
                            inputTax: 57,
                            amount: 1200,
                            description: 'å®¢æˆ¶æ‹œè¨ªé¤è²»',
                            status: 'pending',
                            files: [
                                {
                                    name: 'é¤å»³ç™¼ç¥¨.pdf',
                                    size: 187392,
                                    type: 'application/pdf',
                                    uploadDate: '2024-01-16T12:15:00.000Z'
                                },
                                {
                                    name: 'å®¢æˆ¶æœƒè­°è¨˜éŒ„.docx',
                                    size: 98304,
                                    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                    uploadDate: '2024-01-16T12:20:00.000Z'
                                }
                            ]
                        },
                        {
                            id: 1003,
                            date: '2024-01-17',
                            applicant: currentUser,
                            applicantDept: currentUserDept,
                            accountCode: '6204',
                            salesAmount: 762,
                            taxRate: 5,
                            inputTax: 38,
                            amount: 800,
                            description: 'è¾¦å…¬ç”¨å“æ¡è³¼',
                            status: 'testing',
                            files: [
                                {
                                    name: 'æ¡è³¼æ¸…å–®.xlsx',
                                    size: 45123,
                                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                    uploadDate: '2024-01-17T14:30:00.000Z'
                                }
                            ]
                        }
                    ];
                    console.log('ç¤ºä¾‹è³‡æ–™å·²æ–°å¢');
                }
                
                console.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼');
            } catch(error) {
                console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                throw error;
            }
        }

        // æ›´æ–°å„€è¡¨æ¿
        function updateDashboard() {
            document.getElementById('totalExpenses').textContent = expenses.length;
            document.getElementById('pendingExpenses').textContent = expenses.filter(e => e.status === 'pending').length;
            document.getElementById('approvedExpenses').textContent = expenses.filter(e => e.status === 'approved').length;
            
            const currentMonth = new Date().getMonth();
            const monthlyTotal = expenses
                .filter(e => new Date(e.date).getMonth() === currentMonth && e.status === 'approved')
                .reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('monthlySpending').textContent = `${monthlyTotal.toLocaleString()}`;
        }

        // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
        }

        // æ¨™ç±¤åˆ‡æ›
        function showTab(tabName) {
            console.log('åˆ‡æ›åˆ°æ¨™ç±¤:', tabName); // é™¤éŒ¯ç”¨
            
            try {
                // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });
                
                // ç§»é™¤æ‰€æœ‰æ´»èºæ¨™ç±¤
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤
                const targetTab = document.getElementById(tabName);
                const targetPane = document.querySelector(`#${tabName} .tab-pane`);
                const targetNavTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
                
                if (targetTab) {
                    targetTab.style.display = 'block';
                }
                if (targetPane) {
                    targetPane.classList.add('active');
                }
                if (targetNavTab) {
                    targetNavTab.classList.add('active');
                }
                
                // æ ¹æ“šæ¨™ç±¤è¼‰å…¥å°æ‡‰æ•¸æ“š
                switch(tabName) {
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'expense':
                        loadExpenses();
                        break;
                    case 'testing':
                        loadTestingItems();
                        break;
                    case 'approval':
                        loadApprovalItems();
                        break;
                }
            } catch(error) {
                console.error('æ¨™ç±¤åˆ‡æ›éŒ¯èª¤:', error);
            }
        }

        // è¼‰å…¥æœƒè¨ˆç§‘ç›®
        function loadAccounts() {
            const accountSelect = document.getElementById('accountCode');
            accountSelect.innerHTML = '<option value="">è«‹é¸æ“‡æœƒè¨ˆç§‘ç›®</option>';
            
            accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.code;
                option.textContent = `${account.code} - ${account.name}`;
                accountSelect.appendChild(option);
            });

            const tbody = document.getElementById('accountTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            accounts.forEach(account => {
                const row = tbody.insertRow();
                const usagePercent = ((account.used / account.budget) * 100).toFixed(1);
                const progressColor = usagePercent > 90 ? '#dc3545' : usagePercent > 80 ? '#ffc107' : '#28a745';
                
                row.innerHTML = `
                    <td><strong>${account.code}</strong></td>
                    <td>${account.name}</td>
                    <td>${account.budget.toLocaleString()}</td>
                    <td>${account.used.toLocaleString()}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="progress-bar" style="flex: 1;">
                                <div class="progress-fill" style="width: ${Math.min(usagePercent, 100)}%; background: ${progressColor};"></div>
                            </div>
                            <span style="font-weight: 600;">${usagePercent}%</span>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="editAccount('${account.code}')" style="padding: 8px 15px; margin-right: 5px;">âœï¸ ä¿®æ”¹</button>
                        <button class="btn btn-danger" onclick="deleteAccount('${account.code}')" style="padding: 8px 15px;">ğŸ—‘ï¸ åˆªé™¤</button>
                    </td>
                `;
            });
        }

        // è¼‰å…¥éƒ¨é–€
        function loadDepartments() {
            const deptSelects = [
                document.getElementById('applicantDept'),
                document.getElementById('onBehalfOfDept')
            ];
            
            deptSelects.forEach(select => {
                select.innerHTML = '<option value="">è«‹é¸æ“‡éƒ¨é–€</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.code;
                    option.textContent = `${dept.code} - ${dept.name}`;
                    select.appendChild(option);
                });
            });

            const tbody = document.getElementById('departmentTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            departments.forEach(dept => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${dept.code}</strong></td>
                    <td>${dept.name}</td>
                    <td>${dept.manager}</td>
                    <td>${dept.budget.toLocaleString()}</td>
                    <td>${(dept.used || 0).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editDepartment('${dept.code}')" style="padding: 8px 15px; margin-right: 5px;">âœï¸ ä¿®æ”¹</button>
                        <button class="btn btn-danger" onclick="deleteDepartment('${dept.code}')" style="padding: 8px 15px;">ğŸ—‘ï¸ åˆªé™¤</button>
                    </td>
                `;
            });
        }

        // è¼‰å…¥è²»ç”¨ç”³è«‹
        function loadExpenses() {
            const tbody = document.getElementById('expenseTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            expenses.forEach((expense, index) => {
                const row = tbody.insertRow();
                const statusClass = `status-${expense.status}`;
                const statusText = {
                    'draft': 'è‰ç¨¿',
                    'testing': 'æ¸¬è©¦ä¸­',
                    'pending': 'å¾…å¯©æ ¸',
                    'approved': 'å·²æ ¸å‡†',
                    'rejected': 'å·²æ‹’çµ•'
                };
                
                const workflowProgress = getWorkflowProgress(expense.status);
                
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>${expense.applicant}</td>
                    <td>${expense.accountCode}</td>
                    <td>${expense.amount.toLocaleString()}</td>
                    <td><span class="status-badge ${statusClass}">${statusText[expense.status]}</span></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${workflowProgress}%; background: linear-gradient(90deg, #0f4c75, #3282b8);"></div>
                        </div>
                        <small style="color: #666;">${workflowProgress}% å®Œæˆ</small>
                    </td>
                    <td>
                        <button class="btn btn-info" onclick="viewExpense(${index})" style="padding: 6px 12px; margin-right: 5px;">ğŸ‘ï¸ æª¢è¦–</button>
                        <button class="btn btn-warning" onclick="viewAttachments(${expenses[index].id})" style="padding: 6px 12px; margin-right: 5px;">ğŸ“ é™„ä»¶</button>
                        ${expense.status === 'draft' ? `<button class="btn btn-warning" onclick="editExpense(${index})" style="padding: 6px 12px;">âœï¸ ä¿®æ”¹</button>` : ''}
                    </td>
                `;
            });

            loadApprovalItems();
        }

        // å–å¾—å·¥ä½œæµç¨‹é€²åº¦
        function getWorkflowProgress(status) {
            switch(status) {
                case 'draft': return 25;
                case 'testing': return 50;
                case 'pending': return 75;
                case 'approved': return 100;
                case 'rejected': return 100;
                default: return 0;
            }
        }

        // è¼‰å…¥é ç®—ç¸½è¦½
        function loadBudgetOverview() {
            const container = document.getElementById('budgetOverview');
            let html = '<div class="dashboard-cards">';
            
            accounts.forEach(account => {
                const usagePercent = (account.used / account.budget) * 100;
                const remaining = account.budget - account.used;
                const cardClass = usagePercent > 90 ? 'danger' : 
                                 usagePercent > 80 ? 'warning' : 'success';
                
                html += `
                    <div class="dashboard-card ${cardClass}">
                        <div class="card-header">
                            <span class="card-title">${account.name} (${account.code})</span>
                            <span style="font-size: 24px;">${usagePercent > 90 ? 'ğŸš¨' : usagePercent > 80 ? 'âš ï¸' : 'âœ…'}</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">é ç®—é¡åº¦</div>
                            <div style="font-size: 20px; font-weight: 600;">${account.budget.toLocaleString()}</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">å·²ä½¿ç”¨</div>
                            <div style="font-size: 18px; font-weight: 600; color: ${usagePercent > 90 ? '#dc3545' : '#0f4c75'};">${account.used.toLocaleString()}</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">å‰©é¤˜é¡åº¦</div>
                            <div style="font-size: 18px; font-weight: 600; color: #28a745;">${remaining.toLocaleString()}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(usagePercent, 100)}%; background: ${usagePercent > 90 ? '#dc3545' : usagePercent > 80 ? '#ffc107' : '#28a745'};"></div>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-weight: 600;">ä½¿ç”¨ç‡: ${usagePercent.toFixed(1)}%</div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // è¼‰å…¥æ ¸å‡†è¦å‰‡
        function loadApprovalRules() {
            const tbody = document.getElementById('approvalRulesTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            approvalRules.forEach((rule, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${rule.minAmount.toLocaleString()} - ${rule.maxAmount.toLocaleString()}</td>
                    <td>ç¬¬ ${rule.level} å±¤</td>
                    <td>${rule.approver}</td>
                    <td>${rule.timeLimit} å¤©</td>
                    <td>
                        <button class="btn btn-warning" onclick="editApprovalRule(${index})" style="padding: 6px 12px; margin-right: 5px;">âœï¸ ä¿®æ”¹</button>
                        <button class="btn btn-danger" onclick="deleteApprovalRule(${index})" style="padding: 6px 12px;">ğŸ—‘ï¸ åˆªé™¤</button>
                    </td>
                `;
            });
        }

        // è¼‰å…¥æ¸¬è©¦é …ç›®
        function loadTestingItems() {
            const tbody = document.getElementById('testingTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            const testingExpenses = expenses.filter(expense => expense.status === 'testing');
            
            testingExpenses.forEach(expense => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>#${expense.id}</td>
                    <td>${expense.applicant}</td>
                    <td>é ç®—é©—è­‰</td>
                    <td><span class="status-badge status-testing">é€²è¡Œä¸­</span></td>
                    <td>${new Date().toLocaleString('zh-TW')}</td>
                    <td>
                        <button class="btn btn-success" onclick="completeTest(${expense.id})" style="padding: 6px 12px; margin-right: 5px;">âœ… å®Œæˆæ¸¬è©¦</button>
                        <button class="btn btn-danger" onclick="failTest(${expense.id})" style="padding: 6px 12px;">âŒ æ¸¬è©¦å¤±æ•—</button>
                    </td>
                `;
            });
        }

        // è¼‰å…¥æ ¸å‡†é …ç›®
        function loadApprovalItems() {
            const tbody = document.getElementById('approvalTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            const pendingExpenses = expenses.filter(expense => expense.status === 'pending');
            
            pendingExpenses.forEach(expense => {
                const row = tbody.insertRow();
                const priority = expense.amount > 20000 ? 'é«˜' : expense.amount > 5000 ? 'ä¸­' : 'ä½';
                const priorityClass = expense.amount > 20000 ? 'danger' : expense.amount > 5000 ? 'warning' : 'success';
                
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>${expense.applicant}</td>
                    <td>${expense.applicantDept}</td>
                    <td>${expense.amount.toLocaleString()}</td>
                    <td>${expense.description}</td>
                    <td><span class="status-badge status-${priorityClass}">${priority}</span></td>
                    <td><span class="status-badge status-pending">å¾…æ ¸å‡†</span></td>
                    <td>
                        <button class="btn btn-success" onclick="approveExpense(${expense.id})" style="padding: 6px 12px; margin-right: 5px;">âœ… æ ¸å‡†</button>
                        <button class="btn btn-danger" onclick="rejectExpense(${expense.id})" style="padding: 6px 12px; margin-right: 5px;">âŒ æ‹’çµ•</button>
                        <button class="btn btn-info" onclick="viewExpenseDetail(${expense.id})" style="padding: 6px 12px;">ğŸ‘ï¸ è©³æƒ…</button>
                    </td>
                `;
            });
        }

        // è²»ç”¨ç”³è«‹è¡¨å–®æäº¤
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const expense = {
                id: Date.now(),
                date: new Date().toLocaleDateString('zh-TW'),
                applicant: formData.get('applicant'),
                applicantDept: formData.get('applicantDept'),
                onBehalfOf: formData.get('onBehalfOf'),
                onBehalfOfDept: formData.get('onBehalfOfDept'),
                accountCode: formData.get('accountCode'),
                amount: parseFloat(formData.get('amount')),
                invoiceNumber: formData.get('invoiceNumber'),
                taxId: formData.get('taxId'),
                description: formData.get('description'),
                status: 'testing',
                files: [...uploadedFiles],
                submittedBy: currentUser,
                submittedAt: new Date().toISOString()
            };
            
            // æª¢æŸ¥é ç®—
            if (!checkBudget(expense.accountCode, expense.amount)) {
                return;
            }
            
            expenses.push(expense);
            updateAccountUsage(expense.accountCode, expense.amount);
            
            // æ›´æ–°å·¥ä½œæµç¨‹æŒ‡ç¤ºå™¨
            updateWorkflowIndicator(2);
            
            setTimeout(() => {
                updateWorkflowIndicator(3);
                expense.status = 'pending';
                loadExpenses();
                loadTestingItems();
                updateDashboard();
                alert('è²»ç”¨ç”³è«‹å·²æäº¤ä¸¦é€šéæ¸¬è©¦ï¼Œé€²å…¥æ ¸å‡†æµç¨‹ï¼');
            }, 2000);
            
            loadExpenses();
            loadBudgetOverview();
            this.reset();
            uploadedFiles = [];
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('budgetAlert').innerHTML = '';
            
            alert('è²»ç”¨ç”³è«‹å·²æäº¤ï¼Œæ­£åœ¨é€²è¡Œæ¸¬è©¦æµç¨‹...');
        });

        // æ›´æ–°å·¥ä½œæµç¨‹æŒ‡ç¤ºå™¨
        function updateWorkflowIndicator(step) {
            const steps = document.querySelectorAll('.workflow-step');
            steps.forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
        }

        // é ç®—æª¢æŸ¥
        function checkBudget(accountCode, amount) {
            const account = accounts.find(acc => acc.code === accountCode);
            if (!account) return false;
            
            const newUsage = account.used + amount;
            const usagePercent = (newUsage / account.budget) * 100;
            
            const alertDiv = document.getElementById('budgetAlert');
            
            if (usagePercent > 100) {
                alertDiv.innerHTML = `
                    <div class="budget-alert budget-danger">
                        <span style="font-size: 24px;">ğŸš¨</span>
                        <div>
                            <strong>é ç®—è¶…æ”¯è­¦å‘Šï¼</strong><br>
                            æ­¤ç”³è«‹å°‡ä½¿ ${account.name} è¶…å‡ºé ç®—é¡åº¦ ${(usagePercent - 100).toFixed(1)}%<br>
                            è«‹èª¿æ•´ç”³è«‹é‡‘é¡æˆ–è¯ç¹«è²¡å‹™éƒ¨é–€ã€‚
                        </div>
                    </div>
                `;
                return false;
            } else if (usagePercent > 90) {
                alertDiv.innerHTML = `
                    <div class="budget-alert budget-warning">
                        <span style="font-size: 24px;">âš ï¸</span>
                        <div>
                            <strong>é ç®—è­¦å‘Šï¼</strong><br>
                            æ­¤ç”³è«‹å°‡ä½¿ ${account.name} ä½¿ç”¨ç‡é”åˆ° ${usagePercent.toFixed(1)}%<br>
                            å»ºè­°è¬¹æ…æ§åˆ¶å¾ŒçºŒæ”¯å‡ºã€‚
                        </div>
                    </div>
                `;
            } else {
                alertDiv.innerHTML = `
                    <div class="budget-alert budget-success">
                        <span style="font-size: 24px;">âœ…</span>
                        <div>
                            <strong>é ç®—æª¢æŸ¥é€šéï¼</strong><br>
                            ç”³è«‹å¾Œ ${account.name} ä½¿ç”¨ç‡å°‡ç‚º ${usagePercent.toFixed(1)}%
                        </div>
                    </div>
                `;
            }
            
            return true;
        }

        // ç¨…å‹™è¨ˆç®—åŠŸèƒ½
        function calculateTotal() {
            const salesAmount = parseFloat(document.getElementById('salesAmount').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            
            // è¨ˆç®—é€²é …ç¨…é¡
            const inputTax = salesAmount * (taxRate / 100);
            
            // è¨ˆç®—ç¸½è¨ˆé‡‘é¡
            const totalAmount = salesAmount + inputTax;
            
            // æ›´æ–°æ¬„ä½
            document.getElementById('inputTax').value = inputTax.toFixed(2);
            document.getElementById('amount').value = totalAmount.toFixed(2);
            
            // æ›´æ–°é¡¯ç¤ºæ˜ç´°
            document.getElementById('displaySalesAmount').textContent = `${salesAmount.toLocaleString()}`;
            document.getElementById('displayInputTax').textContent = `${inputTax.toLocaleString()}`;
            document.getElementById('displayTaxRate').textContent = `${taxRate}%`;
            document.getElementById('displayTotalAmount').textContent = `${totalAmount.toLocaleString()}`;
            
            // å¦‚æœæœ‰é¸æ“‡æœƒè¨ˆç§‘ç›®ï¼Œæª¢æŸ¥é ç®—
            const accountCode = document.getElementById('accountCode').value;
            if (accountCode && totalAmount > 0) {
                checkBudget(accountCode, totalAmount);
            }
        }

        // æ›´æ–°ç¨…ç‡
        function updateTaxRate() {
            const taxType = document.getElementById('taxType').value;
            const taxRateInput = document.getElementById('taxRate');
            
            if (taxType === 'custom') {
                taxRateInput.readOnly = false;
                taxRateInput.style.background = 'white';
                taxRateInput.focus();
            } else {
                taxRateInput.readOnly = true;
                taxRateInput.style.background = '#f8f9fa';
                taxRateInput.value = taxType;
            }
            
            calculateTotal();
        }

        // ä¿®æ”¹é ç®—æª¢æŸ¥å‡½æ•¸
        function checkBudgetOnChange() {
            const accountCode = document.getElementById('accountCode').value;
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            
            if (accountCode && amount > 0) {
                checkBudget(accountCode, amount);
            } else {
                document.getElementById('budgetAlert').innerHTML = '';
            }
        }

        // æ›´æ–°æœƒè¨ˆç§‘ç›®ä½¿ç”¨é¡åº¦
        function updateAccountUsage(accountCode, amount) {
            const account = accounts.find(acc => acc.code === accountCode);
            if (account) {
                account.used += amount;
            }
        }

        // å„²å­˜è‰ç¨¿
        function saveDraft() {
            const form = document.getElementById('expenseForm');
            const formData = new FormData(form);
            
                const expense = {
                id: Date.now(),
                date: new Date().toLocaleDateString('zh-TW'),
                applicant: formData.get('applicant'),
                applicantDept: formData.get('applicantDept'),
                onBehalfOf: formData.get('onBehalfOf'),
                onBehalfOfDept: formData.get('onBehalfOfDept'),
                accountCode: formData.get('accountCode'),
                salesAmount: parseFloat(formData.get('salesAmount')) || 0,
                taxRate: parseFloat(formData.get('taxRate')) || 0,
                inputTax: parseFloat(formData.get('inputTax')) || 0,
                amount: parseFloat(formData.get('amount')) || 0,
                invoiceNumber: formData.get('invoiceNumber'),
                taxId: formData.get('taxId'),
                description: formData.get('description'),
                status: 'draft',
                files: [...uploadedFiles],
                submittedBy: currentUser
            };
            
            expenses.push(expense);
            loadExpenses();
            updateDashboard();
            form.reset();
            uploadedFiles = [];
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('budgetAlert').innerHTML = '';
            alert('è‰ç¨¿å·²å„²å­˜ï¼');
        }

        // æ¸¬è©¦æµç¨‹
        function testWorkflow() {
            const form = document.getElementById('expenseForm');
            if (!form.checkValidity()) {
                alert('è«‹å…ˆå®Œæ•´å¡«å¯«å¿…è¦æ¬„ä½');
                return;
            }
            
            alert('é–‹å§‹æ¸¬è©¦æµç¨‹...\n\nâœ… è¡¨å–®é©—è­‰é€šé\nâœ… é ç®—æª¢æŸ¥é€šé\nâœ… å¯©æ ¸æ¬Šé™ç¢ºèª\n\næ¸¬è©¦æµç¨‹å®Œæˆï¼');
        }

        // åŸ·è¡Œç³»çµ±æ¸¬è©¦
        function runSystemTest() {
            const testLevel = document.getElementById('testLevel').value;
            const autoTest = document.getElementById('autoTest').value;
            
            let testResults = '';
            
            switch(testLevel) {
                case 'basic':
                    testResults = 'åŸºæœ¬æ¸¬è©¦å®Œæˆï¼š\nâœ… ç³»çµ±é€£ç·šæ­£å¸¸\nâœ… è³‡æ–™åº«é€£æ¥æ­£å¸¸';
                    break;
                case 'standard':
                    testResults = 'æ¨™æº–æ¸¬è©¦å®Œæˆï¼š\nâœ… ç³»çµ±é€£ç·šæ­£å¸¸\nâœ… è³‡æ–™åº«é€£æ¥æ­£å¸¸\nâœ… é ç®—è¨ˆç®—æ­£ç¢º\nâœ… å¯©æ ¸æµç¨‹æ­£å¸¸';
                    break;
                case 'comprehensive':
                    testResults = 'å®Œæ•´æ¸¬è©¦å®Œæˆï¼š\nâœ… ç³»çµ±é€£ç·šæ­£å¸¸\nâœ… è³‡æ–™åº«é€£æ¥æ­£å¸¸\nâœ… é ç®—è¨ˆç®—æ­£ç¢º\nâœ… å¯©æ ¸æµç¨‹æ­£å¸¸\nâœ… æª”æ¡ˆä¸Šå‚³åŠŸèƒ½\nâœ… å ±è¡¨ç”ŸæˆåŠŸèƒ½\nâœ… æ¬Šé™æ§åˆ¶æ­£å¸¸';
                    break;
            }
            
            alert(`ç³»çµ±æ¸¬è©¦çµæœï¼š\n\n${testResults}\n\nè‡ªå‹•æ¸¬è©¦ï¼š${autoTest === 'enabled' ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨'}`);
        }

        // å®Œæˆæ¸¬è©¦
        function completeTest(expenseId) {
            const expense = expenses.find(exp => exp.id === expenseId);
            if (expense) {
                expense.status = 'pending';
                loadExpenses();
                loadTestingItems();
                loadApprovalItems();
                updateDashboard();
                alert('æ¸¬è©¦å®Œæˆï¼Œç”³è«‹å·²é€²å…¥æ ¸å‡†æµç¨‹ï¼');
            }
        }

        // æ¸¬è©¦å¤±æ•—
        function failTest(expenseId) {
            const reason = prompt('è«‹è¼¸å…¥æ¸¬è©¦å¤±æ•—åŸå› ï¼š');
            if (reason) {
                const expense = expenses.find(exp => exp.id === expenseId);
                if (expense) {
                    expense.status = 'rejected';
                    expense.rejectReason = `æ¸¬è©¦å¤±æ•—ï¼š${reason}`;
                    loadExpenses();
                    loadTestingItems();
                    updateDashboard();
                    alert('æ¸¬è©¦å¤±æ•—ï¼Œç”³è«‹å·²è¢«æ‹’çµ•ï¼');
                }
            }
        }

        // æ ¸å‡†ç”³è«‹
        function approveExpense(id) {
            const expense = expenses.find(exp => exp.id === id);
            if (expense && confirm(`ç¢ºå®šè¦æ ¸å‡† ${expense.applicant} çš„ç”³è«‹å—ï¼Ÿ\né‡‘é¡ï¼š${expense.amount.toLocaleString()}`)) {
                expense.status = 'approved';
                expense.approvedDate = new Date().toLocaleDateString('zh-TW');
                expense.approvedBy = currentUser;
                loadExpenses();
                loadApprovalItems();
                updateDashboard();
                alert('ç”³è«‹å·²æ ¸å‡†ï¼');
            }
        }

        // æ‹’çµ•ç”³è«‹
        function rejectExpense(id) {
            const reason = prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼š');
            if (reason) {
                const expense = expenses.find(exp => exp.id === id);
                if (expense) {
                    expense.status = 'rejected';
                    expense.rejectReason = reason;
                    expense.rejectedDate = new Date().toLocaleDateString('zh-TW');
                    expense.rejectedBy = currentUser;
                    // é€€å›é ç®—
                    updateAccountUsage(expense.accountCode, -expense.amount);
                    loadExpenses();
                    loadApprovalItems();
                    loadBudgetOverview();
                    updateDashboard();
                    alert('ç”³è«‹å·²æ‹’çµ•ï¼');
                }
            }
        }

        // æª”æ¡ˆè™•ç†
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`æª”æ¡ˆ ${file.name} è¶…é 10MB é™åˆ¶`);
                    return;
                }
                
                const allowedTypes = [
                    'application/pdf',
                    'application/msword',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    'application/vnd.ms-excel',
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'image/jpeg',
                    'image/png'
                ];
                
                if (!allowedTypes.includes(file.type)) {
                    alert(`æª”æ¡ˆ ${file.name} æ ¼å¼ä¸æ”¯æ´`);
                    return;
                }
                
                uploadedFiles.push({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadDate: new Date().toISOString()
                });
            });
            
            updateFileList();
        }

        // æ›´æ–°æª”æ¡ˆåˆ—è¡¨
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileIcon = getFileIcon(file.type);
                const fileSize = (file.size / 1024).toFixed(1);
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span style="font-size: 20px;">${fileIcon}</span>
                        <div>
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${fileSize} KB</div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeFile(${index})" style="padding: 8px 12px;">ğŸ—‘ï¸ ç§»é™¤</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        // å–å¾—æª”æ¡ˆåœ–ç¤º
        function getFileIcon(type) {
            if (type.includes('pdf')) return 'ğŸ“„';
            if (type.includes('word')) return 'ğŸ“';
            if (type.includes('excel') || type.includes('sheet')) return 'ğŸ“Š';
            if (type.includes('image')) return 'ğŸ–¼ï¸';
            return 'ğŸ“';
        }

        // ç§»é™¤æª”æ¡ˆ
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        }

        // ç¯©é¸åŠŸèƒ½
        function filterExpenses() {
            // å¯¦ä½œç¯©é¸é‚è¼¯
            console.log('ç¯©é¸åŠŸèƒ½åŸ·è¡Œä¸­...');
        }

        // æª¢è¦–è²»ç”¨è©³æƒ…
        function viewExpense(index) {
            const expense = expenses[index];
            const fileList = expense.files.map(f => f.name).join(', ') || 'ç„¡é™„ä»¶';
            
            alert(`ç”³è«‹è©³æƒ…ï¼š
            
ç”³è«‹ç·¨è™Ÿï¼š#${expense.id}
ç”³è«‹äººï¼š${expense.applicant}
ç”³è«‹éƒ¨é–€ï¼š${expense.applicantDept}
${expense.onBehalfOf ? `ä»£ç”³è«‹äººï¼š${expense.onBehalfOf}` : ''}
${expense.onBehalfOfDept ? `ä»£ç”³è«‹éƒ¨é–€ï¼š${expense.onBehalfOfDept}` : ''}
æœƒè¨ˆç§‘ç›®ï¼š${expense.accountCode}
ç”³è«‹é‡‘é¡ï¼š${expense.amount.toLocaleString()}
ç™¼ç¥¨è™Ÿç¢¼ï¼š${expense.invoiceNumber || 'ç„¡'}
çµ±ä¸€ç·¨è™Ÿï¼š${expense.taxId || 'ç„¡'}
ç”³è«‹èªªæ˜ï¼š${expense.description}
ç”³è«‹ç‹€æ…‹ï¼š${expense.status}
é™„ä»¶ï¼š${fileList}
ç”³è«‹æ™‚é–“ï¼š${expense.date}`);
        }

        function viewExpenseDetail(id) {
            const expense = expenses.find(exp => exp.id === id);
            if (expense) {
                viewExpense(expenses.indexOf(expense));
            }
        }

        // æ¨¡æ…‹æ¡†æ§åˆ¶
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // è¼‰å…¥åˆ†é¡é¸é …
        function loadAccountCategoryOptions() {
            const categorySelect = document.getElementById('accountCategoryInput');
            const categoryFilter = document.getElementById('categoryFilter');
            
            // æ›´æ–°ç§‘ç›®è¡¨å–®çš„åˆ†é¡é¸é …
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">è«‹é¸æ“‡åˆ†é¡</option>';
                accountCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = `${category.icon} ${category.name}`;
                    categorySelect.appendChild(option);
                });
            }
            
            // æ›´æ–°ç¯©é¸å™¨çš„åˆ†é¡é¸é …
            if (categoryFilter) {
                const currentValue = categoryFilter.value;
                categoryFilter.innerHTML = '<option value="">æ‰€æœ‰åˆ†é¡</option>';
                accountCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = `${category.icon} ${category.name}`;
                    categoryFilter.appendChild(option);
                });
                categoryFilter.value = currentValue;
            }
        }

        // è¼‰å…¥åˆ†é¡åˆ—è¡¨
        function loadCategoriesList() {
            const container = document.getElementById('categoriesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            accountCategories.forEach((category, index) => {
                const categoryItem = document.createElement('div');
                categoryItem.style.cssText = `
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-left: 4px solid ${category.color};
                    border-radius: 10px;
                    padding: 15px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                categoryItem.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: #0f4c75; margin-bottom: 5px;">
                            <span style="color: ${category.color}; font-size: 18px;">${category.icon}</span>
                            ${category.name} (${category.id})
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            ${category.description || 'ç„¡èªªæ˜'}
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            ä½¿ç”¨æ­¤åˆ†é¡çš„ç§‘ç›®ï¼š${accounts.filter(acc => acc.category === category.id).length} å€‹
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-warning" onclick="editCategory(${index})" style="padding: 6px 12px;">âœï¸ ä¿®æ”¹</button>
                        <button class="btn btn-danger" onclick="deleteCategory(${index})" style="padding: 6px 12px;">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                `;
                
                container.appendChild(categoryItem);
            });
        }

        // ç·¨è¼¯åˆ†é¡
        function editCategory(index) {
            const category = accountCategories[index];
            if (!category) return;
            
            const newName = prompt('è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±ï¼š', category.name);
            if (newName && newName.trim()) {
                category.name = newName.trim();
                
                const newDesc = prompt('è«‹è¼¸å…¥æ–°çš„åˆ†é¡èªªæ˜ï¼š', category.description || '');
                if (newDesc !== null) {
                    category.description = newDesc.trim();
                }
                
                loadCategoriesList();
                loadAccountCategoryOptions();
                loadAccounts(); // é‡æ–°è¼‰å…¥ç§‘ç›®è¡¨æ ¼ä»¥æ›´æ–°åˆ†é¡é¡¯ç¤º
                alert('åˆ†é¡å·²æ›´æ–°ï¼');
            }
        }

        // åˆªé™¤åˆ†é¡
        function deleteCategory(index) {
            const category = accountCategories[index];
            if (!category) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ç§‘ç›®ä½¿ç”¨æ­¤åˆ†é¡
            const usedByAccounts = accounts.filter(acc => acc.category === category.id);
            if (usedByAccounts.length > 0) {
                alert(`ç„¡æ³•åˆªé™¤åˆ†é¡ã€Œ${category.name}ã€ï¼\n\næ­¤åˆ†é¡è¢«ä»¥ä¸‹ç§‘ç›®ä½¿ç”¨ï¼š\n${usedByAccounts.map(acc => `â€¢ ${acc.code} - ${acc.name}`).join('\n')}\n\nè«‹å…ˆä¿®æ”¹é€™äº›ç§‘ç›®çš„åˆ†é¡ã€‚`);
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Œ${category.name}ã€å—ï¼Ÿ`)) {
                accountCategories.splice(index, 1);
                loadCategoriesList();
                loadAccountCategoryOptions();
                alert('åˆ†é¡å·²åˆªé™¤ï¼');
            }
        }

        // ä¿®æ”¹ç·¨è¼¯æœƒè¨ˆç§‘ç›®å‡½æ•¸
        function editAccount(code) {
            const account = accounts.find(acc => acc.code === code);
            if (account) {
                document.getElementById('accountCodeInput').value = account.code;
                document.getElementById('accountCodeInput').readOnly = true; // ç·¨è¼¯æ™‚ä¸å…è¨±ä¿®æ”¹ä»£ç¢¼
                document.getElementById('accountNameInput').value = account.name;
                document.getElementById('budgetAmountInput').value = account.budget;
                document.getElementById('accountCategoryInput').value = account.category;
                document.getElementById('accountStatusInput').value = account.status || 'active';
                document.getElementById('accountDescInput').value = account.description || '';
                showModal('accountModal');
            }
        }

        // ä¿®æ”¹æ¨¡æ…‹æ¡†é—œé–‰æ™‚çš„é‡ç½®
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // é‡ç½®è¡¨å–®
            if (modalId === 'accountModal') {
                document.getElementById('accountForm').reset();
                document.getElementById('accountCodeInput').readOnly = false;
            } else if (modalId === 'categoryModal') {
                document.getElementById('categoryForm').reset();
            }
        }

        // ä¿®æ”¹showModalå‡½æ•¸ä»¥è¼‰å…¥åˆ†é¡ç›¸é—œæ•¸æ“š
        function showModal(modalId) {
            if (modalId === 'accountModal') {
                loadAccountCategoryOptions();
            } else if (modalId === 'categoryModal') {
                loadCategoriesList();
            }
            document.getElementById(modalId).style.display = 'block';
        }

        // ä¿®æ”¹ç³»çµ±åˆå§‹åŒ–å‡½æ•¸
        function initializeSystem() {
            console.log('é–‹å§‹åˆå§‹åŒ–ç³»çµ±...'); // é™¤éŒ¯ç”¨
            
            try {
                loadAccountCategoryOptions(); // å…ˆè¼‰å…¥åˆ†é¡é¸é …
                loadAccounts();
                console.log('æœƒè¨ˆç§‘ç›®è¼‰å…¥å®Œæˆ');
                
                loadDepartments();
                console.log('éƒ¨é–€è³‡æ–™è¼‰å…¥å®Œæˆ');
                
                loadExpenses();
                console.log('è²»ç”¨è¨˜éŒ„è¼‰å…¥å®Œæˆ');
                
                loadBudgetOverview();
                console.log('é ç®—ç¸½è¦½è¼‰å…¥å®Œæˆ');
                
                loadApprovalRules();
                console.log('æ ¸å‡†è¦å‰‡è¼‰å…¥å®Œæˆ');
                
                updateDashboard();
                console.log('å„€è¡¨æ¿æ›´æ–°å®Œæˆ');
                
                updateLastUpdate();
                console.log('æ™‚é–“æ›´æ–°å®Œæˆ');
                
                // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•¸æ“š
                if (expenses.length === 0) {
                    expenses = [
                        {
                            id: 1001,
                            date: '2024-01-15',
                            applicant: 'ç‹å°æ˜',
                            applicantDept: 'IT',
                            accountCode: '6201',
                            amount: 5000,
                            description: 'å°åŒ—å‡ºå·®äº¤é€šè²»',
                            status: 'approved',
                            files: []
                        },
                        {
                            id: 1002,
                            date: '2024-01-16',
                            applicant: 'æå°è¯',
                            applicantDept: 'MKT',
                            accountCode: '6203',
                            amount: 1200,
                            description: 'å®¢æˆ¶æ‹œè¨ªé¤è²»',
                            status: 'pending',
                            files: []
                        },
                        {
                            id: 1003,
                            date: '2024-01-17',
                            applicant: currentUser,
                            applicantDept: currentUserDept,
                            accountCode: '6204',
                            amount: 800,
                            description: 'è¾¦å…¬ç”¨å“æ¡è³¼',
                            status: 'testing',
                            files: []
                        }
                    ];
                    console.log('ç¤ºä¾‹è³‡æ–™å·²æ–°å¢');
                }
                
                console.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼');
            } catch(error) {
                console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                throw error;
            }
        }

        // éƒ¨é–€è¡¨å–®
        document.getElementById('departmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = document.getElementById('deptCodeInput').value;
            const name = document.getElementById('deptNameInput').value;
            const manager = document.getElementById('deptManagerInput').value;
            const budget = parseFloat(document.getElementById('deptBudgetInput').value);
            const desc = document.getElementById('deptDescInput').value;
            
            const existingIndex = departments.findIndex(dept => dept.code === code);
            
            if (existingIndex >= 0) {
                departments[existingIndex] = { ...departments[existingIndex], name, manager, budget, desc };
            } else {
                departments.push({ code, name, manager, budget, used: 0, desc });
            }
            
            loadDepartments();
            closeModal('departmentModal');
            this.reset();
            alert('éƒ¨é–€è³‡æ–™å·²å„²å­˜ï¼');
        });

        // æ ¸å‡†è¦å‰‡è¡¨å–®
        document.getElementById('approvalRuleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const rule = {
                minAmount: parseFloat(document.getElementById('minAmountInput').value),
                maxAmount: parseFloat(document.getElementById('maxAmountInput').value),
                level: parseInt(document.getElementById('approvalLevelInput').value),
                approver: document.getElementById('approverInput').value,
                timeLimit: parseInt(document.getElementById('timeLimitInput').value),
                autoEscalate: document.getElementById('autoEscalateInput').value
            };
            
            approvalRules.push(rule);
            loadApprovalRules();
            closeModal('approvalRuleModal');
            this.reset();
            alert('æ ¸å‡†è¦å‰‡å·²æ–°å¢ï¼');
        });

        // ç·¨è¼¯åŠŸèƒ½
        function editAccount(code) {
            const account = accounts.find(acc => acc.code === code);
            if (account) {
                document.getElementById('accountCodeInput').value = account.code;
                document.getElementById('accountNameInput').value = account.name;
                document.getElementById('budgetAmountInput').value = account.budget;
                document.getElementById('accountCategoryInput').value = account.category;
                showModal('accountModal');
            }
        }

        function editDepartment(code) {
            const dept = departments.find(d => d.code === code);
            if (dept) {
                document.getElementById('deptCodeInput').value = dept.code;
                document.getElementById('deptNameInput').value = dept.name;
                document.getElementById('deptManagerInput').value = dept.manager;
                document.getElementById('deptBudgetInput').value = dept.budget;
                document.getElementById('deptDescInput').value = dept.desc || '';
                showModal('departmentModal');
            }
        }

        // åˆªé™¤åŠŸèƒ½
        function deleteAccount(code) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æœƒè¨ˆç§‘ç›®å—ï¼Ÿ')) {
                const index = accounts.findIndex(acc => acc.code === code);
                if (index >= 0) {
                    accounts.splice(index, 1);
                    loadAccounts();
                    loadBudgetOverview();
                }
            }
        }

        function deleteDepartment(code) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤éƒ¨é–€å—ï¼Ÿ')) {
                const index = departments.findIndex(dept => dept.code === code);
                if (index >= 0) {
                    departments.splice(index, 1);
                    loadDepartments();
                }
            }
        }

        // å ±è¡¨åŠŸèƒ½
        function exportReport() {
            const reportType = document.getElementById('reportType').value;
            const dateRange = document.getElementById('dateRange').value;
            const format = document.getElementById('reportFormat').value;
            
            let data = [];
            let filename = '';
            
            switch (reportType) {
                case 'expense':
                    data = expenses.map(expense => ({
                        'ç”³è«‹ç·¨è™Ÿ': expense.id,
                        'ç”³è«‹æ—¥æœŸ': expense.date,
                        'ç”³è«‹äºº': expense.applicant,
                        'ç”³è«‹éƒ¨é–€': expense.applicantDept,
                        'ä»£ç”³è«‹äºº': expense.onBehalfOf || '',
                        'æœƒè¨ˆç§‘ç›®': expense.accountCode,
                        'éŠ·å”®é¡': expense.salesAmount || 0,
                        'ç¨…ç‡': (expense.taxRate || 0) + '%',
                        'é€²é …ç¨…é¡': expense.inputTax || 0,
                        'ç¸½è¨ˆé‡‘é¡': expense.amount,
                        'ç™¼ç¥¨è™Ÿç¢¼': expense.invoiceNumber || '',
                        'çµ±ä¸€ç·¨è™Ÿ': expense.taxId || '',
                        'ç‹€æ…‹': expense.status,
                        'ç”³è«‹èªªæ˜': expense.description
                    }));
                    filename = `è²»ç”¨ç”³è«‹å ±è¡¨_${new Date().toLocaleDateString('zh-TW')}`;
                    break;
                    
                case 'budget':
                    data = accounts.map(account => ({
                        'ç§‘ç›®ä»£ç¢¼': account.code,
                        'ç§‘ç›®åç¨±': account.name,
                        'ç§‘ç›®åˆ†é¡': account.category,
                        'é ç®—é¡åº¦': account.budget,
                        'å·²ä½¿ç”¨': account.used,
                        'å‰©é¤˜é ç®—': account.budget - account.used,
                        'ä½¿ç”¨ç‡': ((account.used / account.budget) * 100).toFixed(1) + '%'
                    }));
                    filename = `é ç®—åŸ·è¡Œå ±è¡¨_${new Date().toLocaleDateString('zh-TW')}`;
                    break;
                    
                case 'department':
                    data = departments.map(dept => ({
                        'éƒ¨é–€ä»£ç¢¼': dept.code,
                        'éƒ¨é–€åç¨±': dept.name,
                        'éƒ¨é–€ä¸»ç®¡': dept.manager,
                        'é ç®—é¡åº¦': dept.budget,
                        'å·²ç”¨é ç®—': dept.used || 0,
                        'éƒ¨é–€èªªæ˜': dept.desc || ''
                    }));
                    filename = `éƒ¨é–€è²»ç”¨å ±è¡¨_${new Date().toLocaleDateString('zh-TW')}`;
                    break;
                    
                case 'approval':
                    data = approvalRules.map((rule, index) => ({
                        'è¦å‰‡ç·¨è™Ÿ': index + 1,
                        'æœ€å°é‡‘é¡': rule.minAmount,
                        'æœ€å¤§é‡‘é¡': rule.maxAmount,
                        'æ ¸å‡†å±¤ç´š': rule.level,
                        'å¯©æ ¸äººå“¡': rule.approver,
                        'å¯©æ ¸æ™‚é™': rule.timeLimit + 'å¤©',
                        'è‡ªå‹•å‡ç´š': rule.autoEscalate === 'yes' ? 'æ˜¯' : 'å¦'
                    }));
                    filename = `æ ¸å‡†æµç¨‹å ±è¡¨_${new Date().toLocaleDateString('zh-TW')}`;
                    break;
                    
                case 'testing':
                    data = expenses.filter(e => e.status === 'testing').map(expense => ({
                        'ç”³è«‹ç·¨è™Ÿ': expense.id,
                        'ç”³è«‹äºº': expense.applicant,
                        'ç”³è«‹éƒ¨é–€': expense.applicantDept,
                        'é‡‘é¡': expense.amount,
                        'æ¸¬è©¦ç‹€æ…‹': 'é€²è¡Œä¸­',
                        'é–‹å§‹æ™‚é–“': expense.date
                    }));
                    filename = `æ¸¬è©¦çµæœå ±è¡¨_${new Date().toLocaleDateString('zh-TW')}`;
                    break;
            }
            
            if (data.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }
            
            downloadFile(data, filename, format);
            
            // æ›´æ–°å ±è¡¨é è¦½
            updateReportPreview(data, reportType);
        }

        // æ›´æ–°å ±è¡¨é è¦½
        function updateReportPreview(data, reportType) {
            const preview = document.getElementById('reportPreview');
            
            if (data.length === 0) {
                preview.innerHTML = '<p style="color: #666;">æ²’æœ‰è³‡æ–™å¯é è¦½</p>';
                return;
            }
            
            let html = `<h4 style="color: #0f4c75; margin-bottom: 15px;">${getReportTitle(reportType)}</h4>`;
            html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
            
            // è¡¨é ­
            const headers = Object.keys(data[0]);
            html += '<thead><tr>';
            headers.forEach(header => {
                html += `<th style="background: #0f4c75; color: white; padding: 10px; border: 1px solid #ddd;">${header}</th>`;
            });
            html += '</tr></thead>';
            
            // è³‡æ–™è¡Œï¼ˆæœ€å¤šé¡¯ç¤º5è¡Œï¼‰
            html += '<tbody>';
            const previewData = data.slice(0, 5);
            previewData.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td style="padding: 8px; border: 1px solid #ddd;">${row[header]}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            if (data.length > 5) {
                html += `<p style="margin-top: 10px; color: #666; text-align: center;">é¡¯ç¤ºå‰ 5 ç­†ï¼Œå…± ${data.length} ç­†è³‡æ–™</p>`;
            }
            
            preview.innerHTML = html;
        }

        function getReportTitle(reportType) {
            const titles = {
                'expense': 'è²»ç”¨ç”³è«‹å ±è¡¨',
                'budget': 'é ç®—åŸ·è¡Œå ±è¡¨',
                'department': 'éƒ¨é–€è²»ç”¨å ±è¡¨',
                'approval': 'æ ¸å‡†æµç¨‹å ±è¡¨',
                'testing': 'æ¸¬è©¦çµæœå ±è¡¨'
            };
            return titles[reportType] || 'å ±è¡¨';
        }

        // ä¸‹è¼‰æª”æ¡ˆ
        function downloadFile(data, filename, format) {
            if (format === 'csv') {
                downloadCSV(data, filename + '.csv');
            } else if (format === 'xlsx') {
                // æ¨¡æ“¬ Excel ä¸‹è¼‰
                downloadCSV(data, filename + '.xlsx');
                alert('Excel æ ¼å¼åŒ¯å‡ºå®Œæˆï¼ï¼ˆå¯¦éš›ç’°å¢ƒä¸­æœƒç”¢ç”Ÿ .xlsx æª”æ¡ˆï¼‰');
            } else if (format === 'pdf') {
                alert('PDF åŒ¯å‡ºåŠŸèƒ½éœ€è¦é¡å¤–çš„ PDF ç”Ÿæˆåº«æ”¯æ´');
            }
        }

        // CSV ä¸‹è¼‰åŠŸèƒ½
        function downloadCSV(data, filename) {
            if (data.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // åŒ¯å…¥åŠŸèƒ½
        function importData() {
            if (!hasPermission('all') && currentUserRole !== 'ç³»çµ±ç®¡ç†å“¡') {
                alert('æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡ŒåŒ¯å…¥åŠŸèƒ½');
                return;
            }
            document.getElementById('importFile').click();
        }

        // æ’ç¨‹å ±è¡¨
        function scheduleReport() {
            if (!hasPermission('all') && currentUserRole !== 'ç³»çµ±ç®¡ç†å“¡') {
                alert('æ‚¨æ²’æœ‰æ¬Šé™è¨­å®šæ’ç¨‹å ±è¡¨');
                return;
            }
            
            const reportType = document.getElementById('reportType').value;
            const frequency = prompt('è«‹é¸æ“‡æ’ç¨‹é »ç‡ï¼š\n1. æ¯æ—¥\n2. æ¯é€±\n3. æ¯æœˆ\n\nè«‹è¼¸å…¥ 1, 2, æˆ– 3ï¼š');
            
            if (frequency) {
                const frequencies = { '1': 'æ¯æ—¥', '2': 'æ¯é€±', '3': 'æ¯æœˆ' };
                const selectedFreq = frequencies[frequency];
                
                if (selectedFreq) {
                    alert(`æ’ç¨‹å ±è¡¨è¨­å®šå®Œæˆï¼\n\nå ±è¡¨é¡å‹ï¼š${getReportTitle(reportType)}\næ’ç¨‹é »ç‡ï¼š${selectedFreq}\n\nç³»çµ±å°‡è‡ªå‹•ç”¢ç”Ÿå ±è¡¨ä¸¦ç™¼é€è‡³æ‚¨çš„ä¿¡ç®±ã€‚`);
                } else {
                    alert('ç„¡æ•ˆçš„é¸æ“‡ï¼Œè«‹é‡æ–°è¨­å®šã€‚');
                }
            }
        }

        function handleImport(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const headers = lines[0].split(',');
                    
                    // é€™è£¡å¯ä»¥æ ¹æ“šæª”æ¡ˆæ ¼å¼é€²è¡Œè³‡æ–™åŒ¯å…¥
                    alert(`åŒ¯å…¥åŠŸèƒ½é–‹ç™¼ä¸­...\n\næª”æ¡ˆï¼š${file.name}\nå¤§å°ï¼š${(file.size / 1024).toFixed(1)} KB\nè¡¨é ­ï¼š${headers.slice(0, 3).join(', ')}...`);
                } catch (error) {
                    alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹');
                }
            };
            reader.readAsText(file);
        }

        // æ‹–æ‹½ä¸Šå‚³
        document.addEventListener('DOMContentLoaded', function() {
            const dropArea = document.querySelector('.file-drop-area');
            
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropArea.classList.add('dragover');
                }
                
                function unhighlight() {
                    dropArea.classList.remove('dragover');
                }
                
                dropArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleFiles(files);
                }
            }
        });

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>